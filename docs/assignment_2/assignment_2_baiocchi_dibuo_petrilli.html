<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Francesco Baiocchi">
<meta name="author" content="Christian Di Buò">
<meta name="author" content="Leonardo Petrilli">
<meta name="dcterms.date" content="2025-01-14">

<title>Sexism Detection – NLP Assignments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">NLP Assignments</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../assignment_1/assignment_1_baiocchi_dibuo_petrilli.html"> 
<span class="menu-text">Assignment 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../assignment_2/assignment_2_baiocchi_dibuo_petrilli.html" aria-current="page"> 
<span class="menu-text">Assignment 2</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#assignment-2" id="toc-assignment-2" class="nav-link active" data-scroll-target="#assignment-2">Assignment 2</a></li>
  <li><a href="#contact" id="toc-contact" class="nav-link" data-scroll-target="#contact">Contact</a></li>
  <li><a href="#relevant-material" id="toc-relevant-material" class="nav-link" data-scroll-target="#relevant-material">Relevant Material</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#problem-definition" id="toc-problem-definition" class="nav-link" data-scroll-target="#problem-definition">Problem definition</a></li>
  <li><a href="#approach" id="toc-approach" class="nav-link" data-scroll-target="#approach">Approach</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a></li>
  </ul></li>
  <li><a href="#task-1---0.5-points-model-setup" id="toc-task-1---0.5-points-model-setup" class="nav-link" data-scroll-target="#task-1---0.5-points-model-setup">[Task 1 - 0.5 points] Model setup</a>
  <ul class="collapse">
  <li><a href="#which-llms" id="toc-which-llms" class="nav-link" data-scroll-target="#which-llms">Which LLMs?</a></li>
  </ul></li>
  <li><a href="#task-2---1.0-points-prompt-setup" id="toc-task-2---1.0-points-prompt-setup" class="nav-link" data-scroll-target="#task-2---1.0-points-prompt-setup">[Task 2 - 1.0 points] Prompt setup</a>
  <ul class="collapse">
  <li><a href="#prompt-template" id="toc-prompt-template" class="nav-link" data-scroll-target="#prompt-template">Prompt Template</a></li>
  </ul></li>
  <li><a href="#task-3---1.0-points-inference" id="toc-task-3---1.0-points-inference" class="nav-link" data-scroll-target="#task-3---1.0-points-inference">[Task 3 - 1.0 points] Inference</a>
  <ul class="collapse">
  <li><a href="#notes-2" id="toc-notes-2" class="nav-link" data-scroll-target="#notes-2">Notes</a></li>
  </ul></li>
  <li><a href="#task-4---0.5-points-metrics" id="toc-task-4---0.5-points-metrics" class="nav-link" data-scroll-target="#task-4---0.5-points-metrics">[Task 4 - 0.5 points] Metrics</a></li>
  <li><a href="#task-5---1.0-points-few-shot-inference" id="toc-task-5---1.0-points-few-shot-inference" class="nav-link" data-scroll-target="#task-5---1.0-points-few-shot-inference">[Task 5 - 1.0 points] Few-shot Inference</a>
  <ul class="collapse">
  <li><a href="#instructions-5" id="toc-instructions-5" class="nav-link" data-scroll-target="#instructions-5">Instructions</a></li>
  <li><a href="#notes-3" id="toc-notes-3" class="nav-link" data-scroll-target="#notes-3">Notes</a></li>
  </ul></li>
  <li><a href="#model-2---mistral-7b-v0.3" id="toc-model-2---mistral-7b-v0.3" class="nav-link" data-scroll-target="#model-2---mistral-7b-v0.3">Model 2 - Mistral 7B v0.3</a></li>
  <li><a href="#task-6---1.0-points-error-analysis" id="toc-task-6---1.0-points-error-analysis" class="nav-link" data-scroll-target="#task-6---1.0-points-error-analysis">[Task 6 - 1.0 points] Error Analysis</a>
  <ul class="collapse">
  <li><a href="#model-performances" id="toc-model-performances" class="nav-link" data-scroll-target="#model-performances">Model performances</a></li>
  <li><a href="#word-exploration" id="toc-word-exploration" class="nav-link" data-scroll-target="#word-exploration">Word exploration</a></li>
  <li><a href="#few-shot-experiments" id="toc-few-shot-experiments" class="nav-link" data-scroll-target="#few-shot-experiments">Few Shot Experiments</a></li>
  </ul></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments</a>
  <ul class="collapse">
  <li><a href="#cot" id="toc-cot" class="nav-link" data-scroll-target="#cot">CoT</a></li>
  <li><a href="#a1-dataset" id="toc-a1-dataset" class="nav-link" data-scroll-target="#a1-dataset">A1 dataset</a></li>
  </ul></li>
  <li><a href="#task-7---1.0-points-report" id="toc-task-7---1.0-points-report" class="nav-link" data-scroll-target="#task-7---1.0-points-report">[Task 7 - 1.0 points] Report</a></li>
  <li><a href="#submission" id="toc-submission" class="nav-link" data-scroll-target="#submission">Submission</a></li>
  <li><a href="#faq" id="toc-faq" class="nav-link" data-scroll-target="#faq">FAQ</a></li>
  <li><a href="#the-end" id="toc-the-end" class="nav-link" data-scroll-target="#the-end">The End</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sexism Detection</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Francesco Baiocchi </p>
             <p>Christian Di Buò </p>
             <p>Leonardo Petrilli </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 14, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="assignment-2" class="level1">
<h1>Assignment 2</h1>
<p><strong>Credits</strong>: Federico Ruggeri, Eleonora Mancini, Paolo Torroni</p>
<p><strong>Keywords</strong>: Sexism Detection, Multi-class Classification, LLMs, Prompting</p>
</section>
<section id="contact" class="level1">
<h1>Contact</h1>
<p>For any doubt, question, issue or help, you can always contact us at the following email addresses:</p>
<p>Teaching Assistants:</p>
<ul>
<li><p>Federico Ruggeri -&gt; federico.ruggeri6@unibo.it</p></li>
<li><p>Eleonora Mancini -&gt; e.mancini@unibo.it</p></li>
</ul>
<p>Professor:</p>
<ul>
<li>Paolo Torroni -&gt; p.torroni@unibo.it</li>
</ul>
</section>
<section id="relevant-material" class="level1">
<h1>Relevant Material</h1>
<ul>
<li><p>Tutorial 3</p></li>
<li><p>Huggingface documentation</p></li>
<li><p>Huggingface hub</p></li>
</ul>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>You are tasked to address the <a href="https://github.com/rewire-online/edos">EDOS Task A</a> on sexism detection.</p>
<section id="problem-definition" class="level2">
<h2 class="anchored" data-anchor-id="problem-definition">Problem definition</h2>
<p>Given an input text sentence, the task is to label the sentence as sexist or not sexist (binary classification).</p>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples:</h3>
<p><strong>Text</strong>: *``Schedule a date with her, then don’t show up. Then text her “GOTCHA B___H”.’’*</p>
<p><strong>Label</strong>: Sexist</p>
<p><strong>Text</strong>: <em>``That’s completely ridiculous a woman flashing her boobs is not sexual assault in the slightest.’’</em></p>
<p><strong>Label</strong>: Not sexist</p>
</section>
</section>
<section id="approach" class="level2">
<h2 class="anchored" data-anchor-id="approach">Approach</h2>
<p>We will tackle the binary classification task with LLMs.</p>
<p>In particular, we’ll consider zero-/few-shot prompting approaches to assess the capability of some popular open-source LLMs on this task.</p>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<p>We are going to download LLMs from <a href="https://huggingface.co/">Huggingface</a>.</p>
<p>Many of these open-source LLMs require you to accept their “Community License Agreement” to download them.</p>
<p>In summary:</p>
<ul>
<li><p>If not already, create an account of Huggingface (~2 mins)</p></li>
<li><p>Check a LLM model card page (e.g., <a href="https://huggingface.co/mistralai/Mistral-7B-Instruct-v0.3">Mistral v3</a>) and accept its “Community License Agreement”.</p></li>
<li><p>Go to your account -&gt; Settings -&gt; Access Tokens -&gt; Create new token -&gt; “Repositories permissions” -&gt; add the LLM model card you want to use.</p></li>
<li><p>Save the token (we’ll need it later)</p></li>
</ul>
<section id="huggingface-login" class="level3">
<h3 class="anchored" data-anchor-id="huggingface-login">Huggingface Login</h3>
<p>Once we have created an account and an access token, we need to login to Huggingface via code.</p>
<ul>
<li><p>Type your token and press Enter</p></li>
<li><p>You can say No to Github linking</p></li>
</ul>
<div id="65aac10f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:19:19.800820Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:19:19.800449Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:19:21.384604Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:19:21.383445Z&quot;}" data-outputid="0d56b4f1-7982-49a2-e198-f384a649b742" data-papermill="{&quot;duration&quot;:1.650813,&quot;end_time&quot;:&quot;2025-01-03T22:19:21.386771&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:19:19.735958&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>huggingface<span class="op">-</span>cli login</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The token has not been saved to the git credentials helper. Pass `add_to_git_credential=True` in this function directly or `--add-to-git-credential` if using via `huggingface-cli` if you want to set the git credential as well.
Token is valid (permission: fineGrained).
The token `nlp_assignment2` has been saved to /root/.cache/huggingface/stored_tokens
Your token has been saved to /root/.cache/huggingface/token
Login successful.
The current active token is: `nlp_assignment2`</code></pre>
</div>
</div>
<p>After login, you can download all models associated with your access token in addition to those that are not protected by an access token.</p>
</section>
<section id="data-loading" class="level3">
<h3 class="anchored" data-anchor-id="data-loading">Data Loading</h3>
<p>Since we are only interested in prompting, we do not require a train dataset.</p>
<p>We have preparared a small test set version of EDOS in our dedicated <a href="https://github.com/lt-nlp-lab-unibo/nlp-course-material">Github repository</a>.</p>
<p>Check the <code>Assignment 2/data</code> folder.</p>
<p>It contains:</p>
<ul>
<li><p><code>a2_test.csv</code> → a small test set of 300 samples.</p></li>
<li><p><code>demonstrations.csv</code> -&gt; a batch of 1000 samples for few-shot prompting.</p></li>
</ul>
<p>Both datasets contain a balanced number of sexist and not sexist samples.</p>
</section>
<section id="instructions" class="level3">
<h3 class="anchored" data-anchor-id="instructions">Instructions</h3>
<p>We require you to:</p>
<ul>
<li><p><strong>Download</strong> the <code>A2/data</code> folder.</p></li>
<li><p><strong>Encode</strong> <code>a2_test.csv</code> into a <code>pandas.DataFrame</code> object.</p></li>
</ul>
<div id="42cbcb3f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:19:21.894918Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:19:21.894548Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:06.816924Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:06.815906Z&quot;}" data-papermill="{&quot;duration&quot;:44.989399,&quot;end_time&quot;:&quot;2025-01-03T22:20:06.819107&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:19:21.829708&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install transformers <span class="op">--</span>quiet</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install datasets <span class="op">--</span>quiet</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install accelerate <span class="op">--</span>quiet</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install evaluate <span class="op">--</span>quiet</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install bitsandbytes <span class="op">--</span>quiet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ebd901e6" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:08.376228Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:08.375872Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:11.487793Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:11.486810Z&quot;}" data-outputid="c93c0ef9-7083-46dd-85be-4e717e884ec1" data-papermill="{&quot;duration&quot;:3.179804,&quot;end_time&quot;:&quot;2025-01-03T22:20:11.489423&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:08.309619&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>torch.cuda.is_available()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>True</code></pre>
</div>
</div>
<div id="241a7731" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:11.620684Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:11.619939Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:15.178671Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:15.177776Z&quot;}" data-papermill="{&quot;duration&quot;:3.624803,&quot;end_time&quot;:&quot;2025-01-03T22:20:15.180711&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:11.555908&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># system packages</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.utils.io <span class="im">import</span> capture_output</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># data and numerical management packages</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datasets</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> Dataset</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report, confusion_matrix, ConfusionMatrixDisplay</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> MaxNLocator</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> transformers</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ed33c251" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:15.311550Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:15.310504Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:16.221927Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:16.221027Z&quot;}" data-outputid="bf2345a5-866f-493e-ac25-0d842200afd0" data-papermill="{&quot;duration&quot;:0.978585,&quot;end_time&quot;:&quot;2025-01-03T22:20:16.223748&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:15.245163&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nltk</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nltk.corpus <span class="im">import</span> stopwords</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nltk.download(<span class="st">"punkt_tab"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>nltk.download(<span class="st">"wordnet"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>nltk.download(<span class="st">"averaged_perceptron_tagger_eng"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>nltk.download(<span class="st">"stopwords"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[nltk_data] Downloading package punkt_tab to /usr/share/nltk_data...
[nltk_data]   Unzipping tokenizers/punkt_tab.zip.
[nltk_data] Downloading package wordnet to /usr/share/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package averaged_perceptron_tagger_eng to
[nltk_data]     /usr/share/nltk_data...
[nltk_data]   Unzipping taggers/averaged_perceptron_tagger_eng.zip.
[nltk_data] Downloading package stopwords to /usr/share/nltk_data...
[nltk_data]   Package stopwords is already up-to-date!</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>True</code></pre>
</div>
</div>
<div id="00ba0fbd" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:16.354296Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:16.353952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:16.364075Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:16.363450Z&quot;}" data-papermill="{&quot;duration&quot;:0.077315,&quot;end_time&quot;:&quot;2025-01-03T22:20:16.365776&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:16.288461&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_reproducibility(seed : <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Sets a reproducible environment</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    seed: an integer used as seed</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    torch.random.manual_seed(seed)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed(seed)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed_all(seed)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure reproducibility for PyTorch</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    torch.backends.cudnn.deterministic <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    torch.backends.cudnn.benchmark <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>set_reproducibility(seed<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3107e630" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:16.496079Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:16.495734Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:16.502725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:16.501794Z&quot;}" data-papermill="{&quot;duration&quot;:0.074182,&quot;end_time&quot;:&quot;2025-01-03T22:20:16.504352&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:16.430170&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DownloadProgressBar(tqdm):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_to(<span class="va">self</span>, b<span class="op">=</span><span class="dv">1</span>, bsize<span class="op">=</span><span class="dv">1</span>, tsize<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tsize <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.total <span class="op">=</span> tsize</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.update(b <span class="op">*</span> bsize <span class="op">-</span> <span class="va">self</span>.n)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_dataset(url: <span class="bu">str</span>, file_name: <span class="bu">str</span>, directory: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Download and store a file inside the directory</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    url: the url of the file to download</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    file_name: the name to save the file with</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">    directory: the name in which save the file</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    local_file_path <span class="op">=</span> os.path.join(directory, file_name)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading dataset..."</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> DownloadProgressBar(unit<span class="op">=</span><span class="st">'B'</span>, unit_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                             miniters<span class="op">=</span><span class="dv">1</span>, desc<span class="op">=</span>url.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]) <span class="im">as</span> t:</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(url)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Download complete!"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving the Dataset </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">.csv into local environment..."</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(local_file_path, <span class="st">'wb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(response.content)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File saved successfully"</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to download the file. Status code: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We downloaded the files a2_test.csv and demonstration.csv inside the new dirctory Dataset.</p>
<div id="2ea73de9" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:16.764620Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:16.764279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:17.123807Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:17.122805Z&quot;}" data-outputid="702189db-d5f3-4ade-d168-bbff609c877b" data-papermill="{&quot;duration&quot;:0.42647,&quot;end_time&quot;:&quot;2025-01-03T22:20:17.125594&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:16.699124&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/nlp-unibo/nlp-course-material/main/2024-2025/Assignment%202/data/"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>directory <span class="op">=</span> <span class="st">'Dataset'</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Creating the directory </span><span class="sc">{</span>directory<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    os.makedirs(directory)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>file_name <span class="op">=</span> [<span class="st">'a2_test'</span>, <span class="st">'demonstrations'</span>]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>directory <span class="op">=</span> <span class="st">'Dataset'</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> file_name:</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    download_dataset(url<span class="op">+</span>name<span class="op">+</span><span class="st">'.csv'</span>, name, directory)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating the directory Dataset...
Downloading dataset...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>a2_test.csv: 0.00B [00:00, ?B/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Download complete!
Saving the Dataset a2_test.csv into local environment...
File saved successfully
Downloading dataset...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>demonstrations.csv: 0.00B [00:00, ?B/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Download complete!
Saving the Dataset demonstrations.csv into local environment...
File saved successfully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>We stored the file a2_test.csv in the variable a2_test mapping the target feature from categorical to numerical.</p>
<div id="1412bc12" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:17.387629Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:17.386970Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:17.407105Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:17.406381Z&quot;}" data-outputid="3af09642-4bc5-4053-a570-f4b9878fcb15" data-papermill="{&quot;duration&quot;:0.087855,&quot;end_time&quot;:&quot;2025-01-03T22:20:17.408617&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:17.320762&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>label_mapping <span class="op">=</span> {<span class="st">'sexist'</span>: <span class="dv">1</span>, <span class="st">'not sexist'</span>: <span class="dv">0</span>}</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>local_file_path <span class="op">=</span> os.path.join(directory, <span class="st">'a2_test'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>a2_test <span class="op">=</span> pd.read_csv(local_file_path, converters<span class="op">=</span>{<span class="st">'label_sexist'</span> : <span class="kw">lambda</span> x: label_mapping[x]})</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>a2_test.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rewire_id</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label_sexist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sexism2022_english-17133</td>
<td>The boys must be gaming because there goes the...</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>sexism2022_english-14197</td>
<td>Look at those eyes. Either someone unexpectedl...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>sexism2022_english-3018</td>
<td>Old man mogs everyone in this sub</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>sexism2022_english-5301</td>
<td>Excellent, I was just looking at another post ...</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>sexism2022_english-17796</td>
<td>So you run back to daddy whenever you need hel...</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s explore the data, to understand whether there are some imbalances in the data distributions.</p>
<div id="871033b0" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:17.683571Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:17.683229Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:17.921955Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:17.921144Z&quot;}" data-outputid="5a564070-7664-467d-ff92-79fc99fb0bcc" data-papermill="{&quot;duration&quot;:0.307087,&quot;end_time&quot;:&quot;2025-01-03T22:20:17.923832&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:17.616745&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_data_distribution(df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows the distribution of a dataset split.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df: split of the dataset (pd.DataFrame)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    label_1 <span class="op">=</span> <span class="bu">len</span>(df[df[<span class="st">"label_sexist"</span>] <span class="op">==</span> <span class="dv">1</span>])</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    label_0 <span class="op">=</span> <span class="bu">len</span>(df[df[<span class="st">"label_sexist"</span>] <span class="op">==</span> <span class="dv">0</span>])</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    bar_colors <span class="op">=</span> [<span class="st">"#6baed6"</span>, <span class="st">"#2171b5"</span>]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> plt.bar([<span class="st">"label 1"</span>, <span class="st">"label 0"</span>], [label_1, label_0], color<span class="op">=</span>bar_colors)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    percentages <span class="op">=</span> [label_1 <span class="op">/</span> <span class="bu">len</span>(df)<span class="op">*</span><span class="dv">100</span>, label_0 <span class="op">/</span> <span class="bu">len</span>(df)<span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar, percentage <span class="kw">in</span> <span class="bu">zip</span>(bars, percentages):</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        plt.text(</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>            bar.get_x() <span class="op">+</span> bar.get_width() <span class="op">/</span> <span class="dv">2</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            bar.get_height(),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>percentage<span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Test data distribution'</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"label count"</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>plot_data_distribution(a2_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see from the plot the test set is perfectly balanced between the sexism (label 1) and not sexism (label 0).</p>
<div id="03734aff" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:18.185224Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:18.184588Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:18.211229Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:18.210587Z&quot;}" data-papermill="{&quot;duration&quot;:0.094014,&quot;end_time&quot;:&quot;2025-01-03T22:20:18.213094&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:18.119080&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> Dataset.from_pandas(a2_test)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ground_truth <span class="op">=</span> np.array(test_data[<span class="st">'label_sexist'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="task-1---0.5-points-model-setup" class="level1">
<h1>[Task 1 - 0.5 points] Model setup</h1>
<p>Once the test data has been loaded, we have to setup the model pipeline for inference.</p>
<p>In particular, we have to:</p>
<ul>
<li><p>Load the model weights from Huggingface</p></li>
<li><p>Quantize the model to fit into a single-GPU limited hardware</p></li>
</ul>
<section id="which-llms" class="level2">
<h2 class="anchored" data-anchor-id="which-llms">Which LLMs?</h2>
<p>The pool of LLMs is ever increasing and it’s impossible to keep track of all new entries.</p>
<p>We focus on popular open-source models.</p>
<ul>
<li><p><a href="mistralai/Mistral-7B-Instruct-v0.2">Mistral v2</a></p></li>
<li><p><a href="mistralai/Mistral-7B-Instruct-v0.3">Mistral v3</a></p></li>
<li><p><a href="https://huggingface.co/meta-llama/Llama-3.1-8B-Instruct">Llama v3.1</a></p></li>
<li><p><a href="https://huggingface.co/microsoft/Phi-3-mini-4k-instruct">Phi3-mini</a></p></li>
</ul>
<p>Other open-source models are more than welcome!</p>
<section id="instructions-1" class="level3">
<h3 class="anchored" data-anchor-id="instructions-1">Instructions</h3>
<p>In order to get Task 1 points, we require you to:</p>
<ul>
<li><p>Pick 2 model cards from the provided list.</p></li>
<li><p>For each model:</p>
<ul>
<li><p>Define a separate section of your notebook for the model.</p></li>
<li><p>Setup a quantization configuration for the model.</p></li>
<li><p>Load the model via HuggingFace APIs.</p></li>
</ul></li>
</ul>
</section>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes">Notes</h3>
<ol type="1">
<li><p>There’s a popular library integrated with Huggingface’s <code>transformers</code> to perform quantization.</p></li>
<li><p>Define two separate sections of your notebook to show that you have implemented the prompting pipeline for each selected model card.</p></li>
</ol>
<div id="2ac97546" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:18.902071Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:18.901726Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:18.907031Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:18.906360Z&quot;}" data-papermill="{&quot;duration&quot;:0.072885,&quot;end_time&quot;:&quot;2025-01-03T22:20:18.908577&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:18.835692&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>bnb_config <span class="op">=</span> BitsAndBytesConfig(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    load_in_4bit<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    bnb_4bit_use_double_quant<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    bnb_4bit_quant_type<span class="op">=</span><span class="st">"nf4"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    bnb_4bit_compute_dtype<span class="op">=</span>torch.bfloat16,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3d0bba22" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:19.042052Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:19.041435Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:20:19.046920Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:20:19.046059Z&quot;}" data-papermill="{&quot;duration&quot;:0.072769,&quot;end_time&quot;:&quot;2025-01-03T22:20:19.048540&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:18.975771&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model(model_card : <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Download the model and its tokenizer from Hugging Face and set the configuratons</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    model_card: name of the model to dowload</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Output:</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    model: the downloaded model</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    tokenizer: the tokenizer associated with the model</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(model_card)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    tokenizer.pad_token <span class="op">=</span> tokenizer.eos_token</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        model_card,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        quantization_config<span class="op">=</span>bnb_config,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        device_map<span class="op">=</span><span class="st">'auto'</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    generation_config <span class="op">=</span> model.generation_config</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    generation_config.max_new_tokens <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    generation_config.eos_token_id <span class="op">=</span> tokenizer.eos_token_id</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    generation_config.pad_token_id <span class="op">=</span> tokenizer.eos_token_id</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    generation_config.temperature <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    generation_config.num_return_sequences <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, tokenizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We decide to use Phi3-mini, a model with 3.8 billions parameters developed by Microsoft.</p>
<div id="c392c13a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:20:19.309850Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:20:19.309199Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:45.320568Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:45.319872Z&quot;}" data-outputid="0a15d2ea-6cdd-40fe-bf63-880ae464a003" data-papermill="{&quot;duration&quot;:206.079073,&quot;end_time&quot;:&quot;2025-01-03T22:23:45.322492&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:20:19.243419&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model_card <span class="op">=</span> <span class="st">"microsoft/Phi-3-mini-4k-instruct"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>model_1, tokenizer_1 <span class="op">=</span> get_model(model_card)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ed14bbe9d11a4b01b276ca9c5f5980d0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"65f88c80bf3b4292969517428baf316a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"109549b9308c4eef807502efb27a67ab","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d231067260a443ce98462148624c42cd","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f263d0e0490482a9f4aff5deac5a959","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bd83868af760498eb57a600042b24602","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db60294e53294a109f918f814f7ab675","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"65647434ca894ee1a7ee2d9595435ab4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"610c8c06951a497ebe462ef5b582da8e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3a030261e91e4f529c008bd3dff2fa04","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f17920ae6545485686b711c2b5c840b6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fb23594a55c94289a9166dca88559db5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
</section>
</section>
<section id="task-2---1.0-points-prompt-setup" class="level1">
<h1>[Task 2 - 1.0 points] Prompt setup</h1>
<p>Prompting requires an input pre-processing phase where we convert each input example into a specific instruction prompt.</p>
<section id="prompt-template" class="level2">
<h2 class="anchored" data-anchor-id="prompt-template">Prompt Template</h2>
<p>Use the following prompt template to process input texts.</p>
<div id="d8993f5f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:45.720270Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:45.719205Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:45.723898Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:45.723096Z&quot;}" data-papermill="{&quot;duration&quot;:0.072772,&quot;end_time&quot;:&quot;2025-01-03T22:23:45.725493&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:45.652721&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>zero_shot_prompt <span class="op">=</span> [</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'system'</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">'You are an annotator for sexism detection.'</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'user'</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">"""Your task is to classify input text as containing sexism or not. Respond only YES or NO.</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT:</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">{text}</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER:</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="instructions-2" class="level3">
<h3 class="anchored" data-anchor-id="instructions-2">Instructions</h3>
<p>In order to get Task 2 points, we require you to:</p>
<ul>
<li>Write a <code>prepare_prompts</code> function as the one reported below.</li>
</ul>
<div id="5de3ab0f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:45.992931Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:45.992543Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:45.999720Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:45.998880Z&quot;}" data-papermill="{&quot;duration&quot;:0.081409,&quot;end_time&quot;:&quot;2025-01-03T22:23:46.001503&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:45.920094&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_prompts(texts: Dataset, prompt_template: <span class="bu">list</span>, tokenizer: transformers.AutoTokenizer) <span class="op">-&gt;</span> DataLoader:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">     Formats input text samples into instructions prompts.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">      texts: input texts to classify via prompting</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">      prompt_template: the prompt template provided in this assignment</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">      tokenizer: the transformers Tokenizer object instance associated with the chosen model card</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">      input texts to classify in the form of instruction prompts</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> collate_fn(batch):</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        texts <span class="op">=</span> tokenizer.batch_encode_plus([it[<span class="st">'text'</span>] <span class="cf">for</span> it <span class="kw">in</span> batch], return_tensors<span class="op">=</span><span class="st">'pt'</span>, padding<span class="op">=</span><span class="va">True</span>, truncation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> torch.tensor([it[<span class="st">'label_sexist'</span>] <span class="cf">for</span> it <span class="kw">in</span> batch])</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> texts, sentiment</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_text(text):</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> tokenizer.apply_chat_template(prompt_template, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        text[<span class="st">'text'</span>] <span class="op">=</span> prompt.<span class="bu">format</span>(text<span class="op">=</span>text[<span class="st">'text'</span>])</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    zero_shot_data <span class="op">=</span> texts.<span class="bu">map</span>(<span class="kw">lambda</span> x: format_text(x))</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    zero_shot_data <span class="op">=</span> zero_shot_data.select_columns([<span class="st">'text'</span>, <span class="st">'label_sexist'</span>])</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(zero_shot_data[<span class="st">'text'</span>][<span class="dv">0</span>])</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    data_loader <span class="op">=</span> DataLoader(zero_shot_data,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>                             batch_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>                             shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>                             collate_fn<span class="op">=</span>collate_fn)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_loader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="634deb9a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:46.142607Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:46.141900Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:46.231595Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:46.230683Z&quot;}" data-outputid="c0033bcc-20d9-4f43-c901-5433b92a0f0a" data-papermill="{&quot;duration&quot;:0.159461,&quot;end_time&quot;:&quot;2025-01-03T22:23:46.233888&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:46.074427&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data_loader <span class="op">=</span> prepare_prompts(test_data, zero_shot_prompt, tokenizer_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6a03033becf14129b270aae90fc4d3d0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
</div>
</section>
<section id="notes-1" class="level3">
<h3 class="anchored" data-anchor-id="notes-1">Notes</h3>
<ol type="1">
<li><p>You are free to modify the prompt format (<strong>not its content</strong>) as you like depending on your code implementation.</p></li>
<li><p>Note that the provided prompt has placeholders. You need to format the string to replace placeholders. Huggingface might have dedicated APIs for this.</p></li>
</ol>
</section>
</section>
</section>
<section id="task-3---1.0-points-inference" class="level1">
<h1>[Task 3 - 1.0 points] Inference</h1>
<p>We are now ready to define the inference loop where we prompt the model with each pre-processed sample.</p>
<section id="instructions-3" class="level3">
<h3 class="anchored" data-anchor-id="instructions-3">Instructions</h3>
<p>In order to get Task 3 points, we require you to:</p>
<ul>
<li><p>Write a <code>generate_responses</code> function as the one reported below.</p></li>
<li><p>Write a <code>process_response</code> function as the one reported below.</p></li>
</ul>
<div id="16bdfda5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:46.758693Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:46.758324Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:46.764386Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:46.763510Z&quot;}" data-papermill="{&quot;duration&quot;:0.074166,&quot;end_time&quot;:&quot;2025-01-03T22:23:46.766035&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:46.691869&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_responses(model: transformers.AutoModel, prompt_examples: DataLoader) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function implements the inference loop for a LLM model.</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Given a set of examples, the model is tasked to generate a response.</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">      model: LLM model instance for prompting</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">      prompt_examples: pre-processed text samples</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">      generated responses</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    model_responses <span class="op">=</span> []</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch_x, batch_y <span class="kw">in</span> tqdm(prompt_examples, desc<span class="op">=</span><span class="st">"Generating responses"</span>):</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> model.generate(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>                input_ids<span class="op">=</span>batch_x[<span class="st">'input_ids'</span>].to(model.device),</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                attention_mask<span class="op">=</span>batch_x[<span class="st">'attention_mask'</span>].to(model.device),</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                generation_config<span class="op">=</span>model.generation_config,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>                do_sample<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>                use_cache<span class="op">=</span><span class="va">True</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>            model_responses.extend(response)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model_responses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1c568c9b" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:46.899141Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:46.898548Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:46.902828Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:46.902095Z&quot;}" data-papermill="{&quot;duration&quot;:0.072309,&quot;end_time&quot;:&quot;2025-01-03T22:23:46.904321&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:46.832012&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_response(response: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes a textual response generated by the LLM</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    and processes it to map the response to a binary label.</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">      response: generated response from LLM</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">      parsed binary response: return 1 if YES and 0 if NO</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="cf">if</span> response.split()[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'YES'</span> <span class="cf">else</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6b7248c3" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:47.036848Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:47.036304Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:23:47.040827Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:23:47.039999Z&quot;}" data-papermill="{&quot;duration&quot;:0.072368,&quot;end_time&quot;:&quot;2025-01-03T22:23:47.042430&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:46.970062&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_response(response: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Extracts the answer of the model.</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    respose: the whole prompt given by the model</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> [m <span class="cf">for</span> m <span class="kw">in</span> re.finditer(<span class="ss">f'ANSWER:'</span>, response)][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    parsed <span class="op">=</span> response[match.end():].strip()</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parsed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="988069b8" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:23:47.177911Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:23:47.177190Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:03.645478Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:03.644509Z&quot;}" data-outputid="90e9d3d1-ec7c-4852-f139-c97193ed8766" data-papermill="{&quot;duration&quot;:136.536696,&quot;end_time&quot;:&quot;2025-01-03T22:26:03.647320&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:23:47.110624&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>phi_pred <span class="op">=</span> generate_responses(model_1, data_loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 300/300 [02:16&lt;00:00,  2.20it/s]</code></pre>
</div>
</div>
<div id="f1e97c05" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:03.846583Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:03.846228Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:03.880085Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:03.879436Z&quot;}" data-papermill="{&quot;duration&quot;:0.15487,&quot;end_time&quot;:&quot;2025-01-03T22:26:03.881704&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:03.726834&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> tokenizer_1.batch_decode(phi_pred, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>raw_response <span class="op">=</span> np.array([extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> response])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create a Dataframe which will be used after to address the error of the models</p>
<div id="b85374bf" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:04.198233Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:04.197882Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:04.206967Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:04.206088Z&quot;}" data-papermill="{&quot;duration&quot;:0.090576,&quot;end_time&quot;:&quot;2025-01-03T22:26:04.208626&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:04.118050&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>responses_df <span class="op">=</span> a2_test.copy()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>responses_df <span class="op">=</span> responses_df.drop(<span class="st">'rewire_id'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>responses_df[<span class="st">'phi3_zero_shot'</span>] <span class="op">=</span> raw_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="notes-2" class="level2">
<h2 class="anchored" data-anchor-id="notes-2">Notes</h2>
<ol type="1">
<li>According to our tests, it should take you ~10 mins to perform full inference on 300 samples.</li>
</ol>
</section>
</section>
<section id="task-4---0.5-points-metrics" class="level1">
<h1>[Task 4 - 0.5 points] Metrics</h1>
<p>In order to evaluate selected LLMs, we need to compute performance metrics.</p>
<p>In particular, we are interested in computing <strong>accuracy</strong> since the provided data is balanced with respect to classification classes.</p>
<p>Moreover, we want to compute the ratio of failed responses generated by models.</p>
<p>That is, how frequent the LLM fails to follow instructions and provides incorrect responses that do not address the classification task.</p>
<p>We denote this metric as <strong>fail-ratio</strong>.</p>
<p>In summary, we parse generated responses as follows:</p>
<ul>
<li><p>1 if the model says YES</p></li>
<li><p>0 if the model says NO</p></li>
<li><p>0 if the model does not answer in either way</p></li>
</ul>
<section id="instructions-4" class="level3">
<h3 class="anchored" data-anchor-id="instructions-4">Instructions</h3>
<p>In order to get Task 4 points, we require you to:</p>
<ul>
<li><p>Write a <code>compute_metrics</code> function as the one reported below.</p></li>
<li><p>Compute metrics for the two selected LLMs.</p></li>
</ul>
<p>We considered wrong answers all those who do not contain either yes or no (case unsensitive) in the answer; an answer of the form: yes (or no) + explanation will be considered corrected. This allowed us to define the fail ratio as the ratio of the wrong answers.</p>
<div id="022d99f0" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:05.001670Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:05.000815Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:05.005980Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:05.005133Z&quot;}" data-papermill="{&quot;duration&quot;:0.087001,&quot;end_time&quot;:&quot;2025-01-03T22:26:05.007516&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:04.920515&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fail_ratio(textual_response : <span class="bu">list</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the fail-ratio metrics</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">    textual_response:  the responses generated by the model</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Output:</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">    fail_ratio: the fail ratio metrics</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    wrong_answer <span class="op">=</span> [answer <span class="cf">for</span> answer <span class="kw">in</span> textual_response <span class="cf">if</span> (<span class="st">'YES'</span> <span class="kw">not</span> <span class="kw">in</span> answer.upper() <span class="kw">and</span> <span class="st">'NO'</span> <span class="kw">not</span> <span class="kw">in</span> answer.upper())]</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    n_wrong <span class="op">=</span> <span class="bu">len</span>(wrong_answer)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(textual_response)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    fail_ratio <span class="op">=</span> n_wrong<span class="op">/</span>n_total</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fail_ratio</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="76c5a94d" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:05.169665Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:05.169295Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:05.174997Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:05.174156Z&quot;}" data-papermill="{&quot;duration&quot;:0.089007,&quot;end_time&quot;:&quot;2025-01-03T22:26:05.176607&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:05.087600&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_metrics(responses: np.ndarray, y_true: np.ndarray) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes predicted and ground-truth labels and compute metrics.</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">    In particular, this function computes accuracy and fail-ratio metrics.</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">    This function internally invokes `process_response` to compute metrics.</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">      responses: generated LLM responses</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">      y_true: ground-truth binary labels</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">      dictionary containing desired metrics</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    fail <span class="op">=</span> fail_ratio(responses)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    binary_prediction <span class="op">=</span> [process_response(item) <span class="cf">for</span> item <span class="kw">in</span> responses]</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> np.array(binary_prediction)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> accuracy_score(y_pred<span class="op">=</span>predictions, y_true<span class="op">=</span>y_true)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_pred<span class="op">=</span>predictions, y_true<span class="op">=</span>y_true)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    cr <span class="op">=</span> classification_report(y_pred<span class="op">=</span>predictions, y_true<span class="op">=</span>y_true, output_dict <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'fail_ratio'</span> : fail, <span class="st">'accuracy_score'</span> : acc, <span class="st">'cr'</span>: cr, <span class="st">'cm'</span>: cm}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="96c4067c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:05.334568Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:05.334212Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:05.348379Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:05.347507Z&quot;}" data-outputid="a86f6306-9f87-48e6-c900-84e41eb17662" data-papermill="{&quot;duration&quot;:0.095559,&quot;end_time&quot;:&quot;2025-01-03T22:26:05.349974&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:05.254415&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>metrics_zero_shot_phi <span class="op">=</span> compute_metrics(raw_response, ground_truth)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""fail_ratio: </span><span class="sc">{</span>metrics_zero_shot_phi[<span class="st">"fail_ratio"</span>]<span class="sc">:.4f}</span><span class="ss">,</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="ss">accuracy: </span><span class="sc">{</span>metrics_zero_shot_phi[<span class="st">"accuracy_score"</span>]<span class="sc">:.4f}</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> {<span class="st">'phi3_zero_shot'</span>: metrics_zero_shot_phi}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fail_ratio: 0.0000,
accuracy: 0.6433
</code></pre>
</div>
</div>
</section>
</section>
<section id="task-5---1.0-points-few-shot-inference" class="level1">
<h1>[Task 5 - 1.0 points] Few-shot Inference</h1>
<p>So far, we have tested models in a zero-shot fashion: we provide the input text to classify and instruct the model to generate a response.</p>
<p>We are now interested in performing few-shot prompting to see the impact of providing demonstration examples.</p>
<p>To do so, we slightly change the prompt template as follows.</p>
<div id="5f39cc78" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:05.667884Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:05.667065Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:05.671542Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:05.670695Z&quot;}" data-papermill="{&quot;duration&quot;:0.08632,&quot;end_time&quot;:&quot;2025-01-03T22:26:05.673214&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:05.586894&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>few_shot_prompt <span class="op">=</span> [</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'system'</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">'You are an annotator for sexism detection.'</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'user'</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">"""Your task is to classify input text as containing sexism or not. Respond only YES or NO.</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">        EXAMPLES:</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">{examples}</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT:</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">{text}</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER:</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The new prompt template reports some demonstration examples to instruct the model.</p>
<p>Generally, we provide an equal number of demonstrations per class as shown in the example below.</p>
<div id="fa81c1a4" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:05.988128Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:05.987444Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:05.991549Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:05.990785Z&quot;}" data-papermill="{&quot;duration&quot;:0.084404,&quot;end_time&quot;:&quot;2025-01-03T22:26:05.993109&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:05.908705&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> [</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'system'</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">'You are an annotator for sexism detection.'</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'user'</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">"""Your task is to classify input text as containing sexism or not. Respond only YES or NO.</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="st">        EXAMPLES:</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT: **example 1**</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER: YES</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT: **example 2**</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER: NO</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT:</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">{text}</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER:</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="instructions-5" class="level2">
<h2 class="anchored" data-anchor-id="instructions-5">Instructions</h2>
<p>In order to get Task 5 points, we require you to:</p>
<ul>
<li><p>Load <code>demonstrations.csv</code> and encode it into a <code>pandas.DataFrame</code> object.</p></li>
<li><p>Define a <code>build_few_shot_demonstrations</code> function as the one reported below.</p></li>
<li><p>Perform few-shot inference as in Task 3.</p></li>
<li><p>Compute metrics as in Task 4.</p></li>
</ul>
<p>Load demonstrations.csv and encode it into a pandas.DataFrame object, mapping the taget feature in YES and NO.</p>
<div id="79186c4e" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:06.508726Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:06.508023Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:06.522700Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:06.521911Z&quot;}" data-outputid="f9d5b7d4-9aba-45d0-e892-577294007437" data-papermill="{&quot;duration&quot;:0.132368,&quot;end_time&quot;:&quot;2025-01-03T22:26:06.524307&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:06.391939&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>local_file_path <span class="op">=</span> os.path.join(directory, <span class="st">'demonstrations'</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>label_mapping <span class="op">=</span> {<span class="st">'sexist'</span>: <span class="st">'YES'</span>, <span class="st">'not sexist'</span>: <span class="st">'NO'</span>}</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>demonstrations <span class="op">=</span> pd.read_csv(local_file_path, converters<span class="op">=</span>{<span class="st">'label_sexist'</span> : <span class="kw">lambda</span> x: label_mapping[x]})</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>demonstrations.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rewire_id</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label_sexist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sexism2022_english-10348</td>
<td>I would never have my kid go to a daycare with...</td>
<td>NO</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>sexism2022_english-7950</td>
<td>Democrat women are so butt fucking ugly.</td>
<td>YES</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>sexism2022_english-7742</td>
<td>If you really wanted to twist the knife you’d ...</td>
<td>NO</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>sexism2022_english-16170</td>
<td>Those women are pro-rape. They didn’t care abo...</td>
<td>YES</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>sexism2022_english-9857</td>
<td>Married a bitch... Is it the standard scenario...</td>
<td>YES</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Define a build_few_shot_demonstrations function as the one reported below</p>
<div id="0d5001af" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:06.845577Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:06.844759Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:06.850755Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:06.849984Z&quot;}" data-papermill="{&quot;duration&quot;:0.087914,&quot;end_time&quot;:&quot;2025-01-03T22:26:06.852247&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:06.764333&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_few_shot_demonstrations(demonstrations: pd.DataFrame, num_per_class: <span class="bu">int</span><span class="op">=</span><span class="dv">2</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function extracts random examples from the demonstrations.</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">      demonstrations: the pandas.DataFrame object wrapping demonstrations.csv</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">      num_per_class: number of demonstrations per class</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">      a string of textual demonstrations to inject into the prompt template.</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    demonstration_list <span class="op">=</span> []</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_per_class):</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        demonstration_list.append((demonstrations[demonstrations[<span class="st">'label_sexist'</span>] <span class="op">==</span> <span class="st">'YES'</span>].sample(<span class="dv">1</span>, axis <span class="op">=</span> <span class="dv">0</span>)[<span class="st">'text'</span>].values[<span class="dv">0</span>], <span class="st">'YES'</span>))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        demonstration_list.append((demonstrations[demonstrations[<span class="st">'label_sexist'</span>] <span class="op">==</span> <span class="st">'NO'</span>].sample(<span class="dv">1</span>, axis <span class="op">=</span> <span class="dv">0</span>)[<span class="st">'text'</span>].values[<span class="dv">0</span>], <span class="st">'NO'</span>))</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    demonstration_samples <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join([<span class="ss">f'TEXT: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ch">\n</span><span class="ss">ANSWER: </span><span class="sc">{</span>answer<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> (text, answer) <span class="kw">in</span> demonstration_list])</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> demonstration_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="75e33485" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:07.012418Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:07.011587Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:07.019082Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:07.018369Z&quot;}" data-papermill="{&quot;duration&quot;:0.089438,&quot;end_time&quot;:&quot;2025-01-03T22:26:07.020561&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:06.931123&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_prompts_few_shot(texts: Dataset,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                             prompt_template: <span class="bu">list</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                             tokenizer: transformers.AutoTokenizer,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                             demonstration_samples: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                             num_per_class: <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span>) <span class="op">-&gt;</span> DataLoader:</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">    This function formats input text samples into instructions prompts with examples.</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co">      texts: input texts to classify via prompting</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">      prompt_template: the prompt template provided in this assignment</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co">      tokenizer: the transformers Tokenizer object instance associated with the chosen model card</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">      demonstration_samples: the examples used to format the prompt</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co">      input texts to classify in the form of instruction prompts</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_text(text):</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> tokenizer.apply_chat_template(prompt_template, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demonstration_samples <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>          text[<span class="st">'text'</span>] <span class="op">=</span> prompt.<span class="bu">format</span>(text<span class="op">=</span>text[<span class="st">'text'</span>], examples<span class="op">=</span> build_few_shot_demonstrations(demonstrations, num_per_class <span class="op">=</span> num_per_class))</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>          text[<span class="st">'text'</span>] <span class="op">=</span> prompt.<span class="bu">format</span>(text<span class="op">=</span>text[<span class="st">'text'</span>], examples<span class="op">=</span> demonstration_samples)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> collate_fn(batch):</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>        texts <span class="op">=</span> tokenizer.batch_encode_plus([it[<span class="st">'text'</span>] <span class="cf">for</span> it <span class="kw">in</span> batch], return_tensors<span class="op">=</span><span class="st">'pt'</span>, padding<span class="op">=</span><span class="va">True</span>, truncation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> torch.tensor([it[<span class="st">'label_sexist'</span>] <span class="cf">for</span> it <span class="kw">in</span> batch])</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> texts, sentiment</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    few_shot_data <span class="op">=</span> texts.<span class="bu">map</span>(<span class="kw">lambda</span> x: format_text(x))</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    few_shot_data <span class="op">=</span> few_shot_data.select_columns([<span class="st">'text'</span>, <span class="st">'label_sexist'</span>])</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(few_shot_data[<span class="st">'text'</span>][<span class="dv">0</span>])</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    data_loader <span class="op">=</span> DataLoader(few_shot_data,</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>                             batch_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>                             shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>                             collate_fn<span class="op">=</span>collate_fn)</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_loader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To ensure reproducibility and a fair comparison between the models, we limited the demonstrations to two examples per class, randomly extracted from the demonstrations file. All prompt templates are then formatted using the extracted sentences from the dataset and the same fixed set of demonstrations for consistency across all experiments.</p>
<div id="8b987fa3" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:07.342068Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:07.341363Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:07.350369Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:07.349457Z&quot;}" data-outputid="ca8f2cbd-f013-41bd-e640-dd2c2e0b8c61" data-papermill="{&quot;duration&quot;:0.093641,&quot;end_time&quot;:&quot;2025-01-03T22:26:07.352503&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:07.258862&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>demonstration_samples <span class="op">=</span> build_few_shot_demonstrations(demonstrations, num_per_class<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(demonstration_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TEXT: nothing irks a left wing feminist worse than seeing a beautiful virtuous woman who is conservative they HATE her H-A-T-E so they try to suppress her next it will be illegal to be born beautiful they'll call it "Hate Birth"
ANSWER: YES
TEXT: Reposting this since all the mailboxes were full over the weekend. Please everybody call! #ReleaseTheMemo
ANSWER: NO
TEXT: It's not old. The women that are 35+ are far more mature, know what they want, and go for it. They don't play the same games and I appreciate them far more for it. Also, they fuck you so much better... no joke.
ANSWER: YES
TEXT: Greece, African and moslems first stop to the UK.
ANSWER: NO</code></pre>
</div>
</div>
<div id="91db02e7" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:07.516340Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:07.515516Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:26:07.602237Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:26:07.601411Z&quot;}" data-outputid="c55b22b0-0008-4573-ffd7-f3aecc90b874" data-papermill="{&quot;duration&quot;:0.171365,&quot;end_time&quot;:&quot;2025-01-03T22:26:07.605070&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:07.433705&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>data_loader_fs <span class="op">=</span> prepare_prompts_few_shot(test_data, prompt_template<span class="op">=</span> few_shot_prompt, tokenizer<span class="op">=</span> tokenizer_1, demonstration_samples<span class="op">=</span> demonstration_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f04ca029abcf450990dbdafeb5ea0290","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        EXAMPLES:
        TEXT: nothing irks a left wing feminist worse than seeing a beautiful virtuous woman who is conservative they HATE her H-A-T-E so they try to suppress her next it will be illegal to be born beautiful they'll call it "Hate Birth"
ANSWER: YES
TEXT: Reposting this since all the mailboxes were full over the weekend. Please everybody call! #ReleaseTheMemo
ANSWER: NO
TEXT: It's not old. The women that are 35+ are far more mature, know what they want, and go for it. They don't play the same games and I appreciate them far more for it. Also, they fuck you so much better... no joke.
ANSWER: YES
TEXT: Greece, African and moslems first stop to the UK.
ANSWER: NO

        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
</div>
<p>Perform few-shot inference as in Task 3.</p>
<div id="fdcef81b" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:26:08.093323Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:26:08.092977Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:29:46.903549Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:29:46.902653Z&quot;}" data-outputid="32dd114a-b25e-4fb8-a2e3-fc0d1a165308" data-papermill="{&quot;duration&quot;:218.893749,&quot;end_time&quot;:&quot;2025-01-03T22:29:46.905437&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:26:08.011688&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>phi_pred_fs <span class="op">=</span> generate_responses(model_1, data_loader_fs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 300/300 [03:38&lt;00:00,  1.37it/s]</code></pre>
</div>
</div>
<div id="374d31b2" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:29:47.132360Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:29:47.132015Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:29:47.205669Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:29:47.204983Z&quot;}" data-papermill="{&quot;duration&quot;:0.208952,&quot;end_time&quot;:&quot;2025-01-03T22:29:47.207434&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:29:46.998482&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> tokenizer_1.batch_decode(phi_pred_fs, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>raw_response <span class="op">=</span> np.array([extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> response])</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>responses_df[<span class="st">'phi3_few_shot'</span>] <span class="op">=</span> raw_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compute metrics as in Task 4.</p>
<div id="256a0e70" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:29:47.581695Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:29:47.581324Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:29:47.594098Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:29:47.593141Z&quot;}" data-outputid="a2ad6d6a-5cec-4986-937d-0020edbd14fd" data-papermill="{&quot;duration&quot;:0.108016,&quot;end_time&quot;:&quot;2025-01-03T22:29:47.595776&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:29:47.487760&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>metrics_few_shot_phi <span class="op">=</span> compute_metrics(raw_response, ground_truth)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>metrics[<span class="st">'phi3_few_shot'</span>] <span class="op">=</span> metrics_few_shot_phi</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""fail_ratio: </span><span class="sc">{</span>metrics_few_shot_phi[<span class="st">"fail_ratio"</span>]<span class="sc">:.4f}</span><span class="ss">,</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="ss">accuracy: </span><span class="sc">{</span>metrics_few_shot_phi[<span class="st">"accuracy_score"</span>]<span class="sc">:.4f}</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fail_ratio: 0.0000,
accuracy: 0.6700
</code></pre>
</div>
</div>
</section>
<section id="notes-3" class="level2">
<h2 class="anchored" data-anchor-id="notes-3">Notes</h2>
<ol type="1">
<li><p>You are free to pick any value for <code>num_per_class</code>.</p></li>
<li><p>According to our tests, few-shot prompting increases inference time by some minutes (we experimented with <code>num_per_class</code> <span class="math inline">\(\in [2, 4]\)</span>).</p></li>
</ol>
</section>
</section>
<section id="model-2---mistral-7b-v0.3" class="level1">
<h1>Model 2 - Mistral 7B v0.3</h1>
<p>In this section we performed zero shot and few shot techniques on the model <strong>Mistral 7B instruct v0.3</strong> of MistralAI.</p>
<div id="f3646a56" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:29:48.341014Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:29:48.340268Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:36:11.573312Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:36:11.572548Z&quot;}" data-outputid="a92eb391-6f88-4669-8b97-35994a037e2e" data-papermill="{&quot;duration&quot;:383.329298,&quot;end_time&quot;:&quot;2025-01-03T22:36:11.575339&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:29:48.246041&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>model_card <span class="op">=</span> <span class="st">"mistralai/Mistral-7B-Instruct-v0.3"</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>model_2, tokenizer_2<span class="op">=</span> get_model(model_card)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"99f3c7763f3a44879452039acb4d8701","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"70ebefbac3ab44928527ec11b56d2622","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dc0e30e6fbf2490fb067a9de4d0fc08b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7423cc44bb2940138ed2af09ed2e90b8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f5aa0807bb046889b7e52322491bc76","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"152d76260dd6483ab5dc942c9e84426e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a8e6c4dd08404586b206b62380a5fd3e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e16442020f1e40349d3779fcb6dceb5d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2c6f11685a324f7c85f530c8bbf7c6c4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8da70603ede74a5fa39878bc52cdc8e2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8da85c45c13e4b07ad5f756b3b44cf85","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7d0103df727d4130889bc2ff59d0077a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<section id="zero-shot" class="level3">
<h3 class="anchored" data-anchor-id="zero-shot">Zero-Shot</h3>
<div id="a91270f0" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:36:11.953377Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:36:11.953034Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:36:12.072441Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:36:12.071616Z&quot;}" data-outputid="f32dc93f-1c74-4704-fd73-cd7da31ba6d3" data-papermill="{&quot;duration&quot;:0.217334,&quot;end_time&quot;:&quot;2025-01-03T22:36:12.075327&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:36:11.857993&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>data_loader <span class="op">=</span> prepare_prompts(test_data, zero_shot_prompt, tokenizer_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3291395c05e843e6b7dc86154a5231a8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        [/INST]</code></pre>
</div>
</div>
<div id="55042c1c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:36:12.269508Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:36:12.269148Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:40:07.320871Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:40:07.319795Z&quot;}" data-outputid="35ad4811-cbaf-4f39-c6f8-08bd54f1e099" data-papermill="{&quot;duration&quot;:235.150306,&quot;end_time&quot;:&quot;2025-01-03T22:40:07.322567&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:36:12.172261&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mistral_pred_zs <span class="op">=</span> generate_responses(model_2, data_loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses:   0%|          | 0/300 [00:00&lt;?, ?it/s]Asking to truncate to max_length but no maximum length is provided and the model has no predefined maximum length. Default to no truncation.
Generating responses: 100%|██████████| 300/300 [03:55&lt;00:00,  1.28it/s]</code></pre>
</div>
</div>
<div id="21c6d3d0" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:40:07.544183Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:40:07.543341Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:40:07.584200Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:40:07.583490Z&quot;}" data-papermill="{&quot;duration&quot;:0.153267,&quot;end_time&quot;:&quot;2025-01-03T22:40:07.585957&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:40:07.432690&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> tokenizer_2.batch_decode(mistral_pred_zs, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>raw_response <span class="op">=</span> np.array([extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> response])</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>responses_df[<span class="st">'mistral_zero_shot'</span>] <span class="op">=</span> raw_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="aed92f47" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:40:07.849080Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:40:07.848181Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:40:07.861778Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:40:07.860872Z&quot;}" data-outputid="5095947e-3719-4a7d-bf5f-c1ea5bb165a8" data-papermill="{&quot;duration&quot;:0.124874,&quot;end_time&quot;:&quot;2025-01-03T22:40:07.863323&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:40:07.738449&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>metrics_mistral_zero_shot <span class="op">=</span> compute_metrics(raw_response, ground_truth)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>metrics[<span class="st">'mistral_zero_shot'</span>] <span class="op">=</span> metrics_mistral_zero_shot</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""fail_ratio: </span><span class="sc">{</span>metrics_mistral_zero_shot[<span class="st">"fail_ratio"</span>]<span class="sc">:.4f}</span><span class="ss">,</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="ss">accuracy: </span><span class="sc">{</span>metrics_mistral_zero_shot[<span class="st">"accuracy_score"</span>]<span class="sc">:.4f}</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fail_ratio: 0.0000,
accuracy: 0.5900
</code></pre>
</div>
</div>
</section>
<section id="few-shot" class="level3">
<h3 class="anchored" data-anchor-id="few-shot">Few-Shot</h3>
<div id="a9608036" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:40:08.296704Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:40:08.296300Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:40:08.401855Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:40:08.401065Z&quot;}" data-outputid="01d3741e-c4e7-4a63-ef5f-e7c51c14833c" data-papermill="{&quot;duration&quot;:0.216792,&quot;end_time&quot;:&quot;2025-01-03T22:40:08.404889&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:40:08.188097&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>data_loader_fs <span class="op">=</span> prepare_prompts_few_shot(test_data, prompt_template<span class="op">=</span> few_shot_prompt, tokenizer<span class="op">=</span> tokenizer_2, demonstration_samples<span class="op">=</span> demonstration_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4a354e2d36494da3849fafad30a8ecb3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        EXAMPLES:
        TEXT: nothing irks a left wing feminist worse than seeing a beautiful virtuous woman who is conservative they HATE her H-A-T-E so they try to suppress her next it will be illegal to be born beautiful they'll call it "Hate Birth"
ANSWER: YES
TEXT: Reposting this since all the mailboxes were full over the weekend. Please everybody call! #ReleaseTheMemo
ANSWER: NO
TEXT: It's not old. The women that are 35+ are far more mature, know what they want, and go for it. They don't play the same games and I appreciate them far more for it. Also, they fuck you so much better... no joke.
ANSWER: YES
TEXT: Greece, African and moslems first stop to the UK.
ANSWER: NO

        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        [/INST]</code></pre>
</div>
</div>
<div id="9b347bc7" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:40:08.626093Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:40:08.625730Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:12.240896Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:12.239989Z&quot;}" data-outputid="6efd253b-a61e-40aa-bdc3-bd98a2c7134d" data-papermill="{&quot;duration&quot;:423.727678,&quot;end_time&quot;:&quot;2025-01-03T22:47:12.242824&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:40:08.515146&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>mistral_pred_fs <span class="op">=</span> generate_responses(model_2, data_loader_fs)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> tokenizer_2.batch_decode(mistral_pred_fs, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>raw_response <span class="op">=</span> np.array([extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> response])</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>responses_df[<span class="st">'mistral_few_shot'</span>] <span class="op">=</span> raw_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 300/300 [07:03&lt;00:00,  1.41s/it]</code></pre>
</div>
</div>
<div id="7dc521fe" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:12.491779Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:12.491013Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:12.503616Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:12.502685Z&quot;}" data-outputid="2b5068e1-a856-4269-be4e-ff869a5f78fd" data-papermill="{&quot;duration&quot;:0.136636,&quot;end_time&quot;:&quot;2025-01-03T22:47:12.505233&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:12.368597&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>metrics_mistral_few_shot <span class="op">=</span> compute_metrics(raw_response, ground_truth)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>metrics[<span class="st">'mistral_few_shot'</span>] <span class="op">=</span> metrics_mistral_few_shot</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""fail_ratio: </span><span class="sc">{</span>metrics_mistral_few_shot[<span class="st">"fail_ratio"</span>]<span class="sc">:.4f}</span><span class="ss">,</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="ss">accuracy: </span><span class="sc">{</span>metrics_mistral_few_shot[<span class="st">"accuracy_score"</span>]<span class="sc">:.4f}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fail_ratio: 0.0000,
accuracy: 0.6967
</code></pre>
</div>
</div>
</section>
</section>
<section id="task-6---1.0-points-error-analysis" class="level1">
<h1>[Task 6 - 1.0 points] Error Analysis</h1>
<p>We are now interested in evaluating model responses and comparing their performance.</p>
<p>This analysis helps us in understanding</p>
<ul>
<li><p>Classification task performance gap: are the models good at this task?</p></li>
<li><p>Generation quality: which kind of responses do models generate?</p></li>
<li><p>Errors: which kind of mistakes do models do?</p></li>
</ul>
<section id="instructions-6" class="level3">
<h3 class="anchored" data-anchor-id="instructions-6">Instructions</h3>
<p>In order to get Task 6 points, we require you to:</p>
<ul>
<li><p>Compare classification performance of selected LLMs in a Table.</p></li>
<li><p>Compute confusion matrices for selected LLMs.</p></li>
<li><p>Briefly summarize your observations on generated responses.</p></li>
</ul>
</section>
<section id="model-performances" class="level2">
<h2 class="anchored" data-anchor-id="model-performances">Model performances</h2>
<p>Let’s explore the Confusion Matrix and Classification Reports of the models to analyse the errors.</p>
<div id="bb0e1e36" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:13.494201Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:13.493675Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:13.507522Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:13.506078Z&quot;}" data-papermill="{&quot;duration&quot;:0.15173,&quot;end_time&quot;:&quot;2025-01-03T22:47:13.509425&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:13.357695&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_results(model_name : <span class="bu">str</span>, metrics : <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function plots the confusion matrix and classification report of the desired model</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">    for both the zero shot and few shot</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Input</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name: the name of the model to plot the metrics of</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics: a dictionary containing the computed metrics</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    keys <span class="op">=</span> [key <span class="cf">for</span> key <span class="kw">in</span> metrics.keys() <span class="cf">if</span> model_name <span class="kw">in</span> key]</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, key <span class="kw">in</span> <span class="bu">enumerate</span>(keys):</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> metrics[key][<span class="st">'cm'</span>]</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        disp <span class="op">=</span> ConfusionMatrixDisplay(cm)</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">0</span>][idx].set_title(key)</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>        disp.plot(ax<span class="op">=</span>axs[<span class="dv">0</span>][idx], colorbar<span class="op">=</span><span class="va">False</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>        cr <span class="op">=</span> metrics[key][<span class="st">'cr'</span>]</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        report_df <span class="op">=</span> pd.DataFrame(cr).T</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>        report_df.iloc[:, :<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> report_df.iloc[:, :<span class="op">-</span><span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>        report_df.loc[<span class="st">"accuracy"</span>, [<span class="st">"precision"</span>, <span class="st">"recall"</span>]] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>        report_df.loc[<span class="st">"accuracy"</span>, <span class="st">"support"</span>] <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a styled table</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>][idx].axis(<span class="st">"off"</span>)</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>        table_data <span class="op">=</span> report_df.reset_index()</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>        table <span class="op">=</span> axs[<span class="dv">1</span>][idx].table(cellText<span class="op">=</span>table_data.values, colLabels<span class="op">=</span>table_data.columns,</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>                        cellLoc<span class="op">=</span><span class="st">"center"</span>, loc<span class="op">=</span><span class="st">"center"</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Style the table</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>        table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>        table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>        table.auto_set_column_width(col<span class="op">=</span><span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(table_data.columns))))</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply styles to headers and rows</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (row, col), cell <span class="kw">in</span> table.get_celld().items():</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>            cell.set_edgecolor(<span class="st">"black"</span>)</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> row <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>                cell.set_text_props(weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>                cell.set_facecolor(<span class="st">"#f4f4f4"</span>)</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> col <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>                cell.set_text_props(weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>                cell.set_facecolor(<span class="st">"#f4f4f4"</span>)</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> table_data.values[row <span class="op">-</span> <span class="dv">1</span>, col] <span class="cf">if</span> row <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> table_data.columns[col]  <span class="co"># Adjust index for header</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pd.isna(value):</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>                    cell.get_text().set_text(<span class="st">""</span>)</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>                cell.set_facecolor(<span class="st">"white"</span>)</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>                cell.set_alpha(<span class="fl">0.9</span>)</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>][idx].set_title(key, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Observing <strong>Phi3</strong> confusion matrix and classification report we can note that: - the error are quite balanced in both the zero shot and few shot between the sexist and non sexist label; this is confirmed also by the classification report, indeed the precision and recall on zero shot are basically equal, this is positive since the models seems to not present strong imbalances. - from the accuracy score we can see that the perfomances slightly increase in the few shot, this was expected since providing demonstration should help the model to better classify sentences. Diving deeper we can notice that only 6 sentences more are correctly classified in few shot, with respect to zero shot and all of them are from the label 1. This lead to different values in precision and recall and it could imply that the demonstration sentences, taken randomly, only help the model to understand sexism.</p>
<div id="becf8624" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:14.064434Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:14.064095Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:15.023566Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:15.022698Z&quot;}" data-outputid="30c05e78-7a2f-4ca4-8e33-242e4dba73a7" data-papermill="{&quot;duration&quot;:1.083159,&quot;end_time&quot;:&quot;2025-01-03T22:47:15.025394&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:13.942235&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>plot_results(<span class="st">'phi'</span>, metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Observing <strong>Mistral v0.3</strong> confusion matrix and classification report we can note that: - The errors are highly imbalanced in the zero shot, indeed the model almost predicts all the sentences as sexist. Precision and recall are completely different on label 0, highlighting the fact that almost all sentences have been wrongly classified. In fact, the accuracy is slightly better than the one of the random classifier (0.59). - In few-shot, the performance improves, reaching 0.7 accuracy. This improvement highlights, even more than Phi3, the importance of the examples provided. However, the model remains strongly imbalanced in its predictions, with 81 of the total errors made on label 1. Additionally, we observe a slight decrease in Mistral’s performance on label 1 in few-shot, with the model misclassifying 7 more sentences compared to zero-shot</p>
<div id="7f2b5398" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:15.516653Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:15.516286Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:16.096809Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:16.095383Z&quot;}" data-outputid="fb6db786-c462-4757-f3ec-390ac13c5ff2" data-papermill="{&quot;duration&quot;:0.70655,&quot;end_time&quot;:&quot;2025-01-03T22:47:16.100173&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:15.393623&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>plot_results(<span class="st">'mistral'</span>, metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-48-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>After analyzing the performance of each model individually, let’s now compare them by focusing on the key metrics.</p>
<div id="7130ee35" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:16.633119Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:16.632377Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:16.639817Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:16.638979Z&quot;}" data-papermill="{&quot;duration&quot;:0.131755,&quot;end_time&quot;:&quot;2025-01-03T22:47:16.641352&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:16.509597&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_performances_table(metrics : <span class="bu">dict</span>, save_file : <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>, file_name : <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows in table format the metrics contained in the metrics_dict and saved them as a tex table whether required</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics: dictionary containing the metrics to show in table format</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co">    save_file: boolean attribute, specify whther the table will be saved in your local environment</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co">    file_name: the name of the file to be saved with</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_file <span class="kw">and</span> file_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"file_name must be specified if save_file is setted to True"</span>)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    performances <span class="op">=</span> {<span class="st">'accuracy_score'</span>:[], <span class="st">'fail_ratio'</span>:[], <span class="st">'f1-score'</span>:[]}</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> metrics.keys():</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>      performances[<span class="st">'accuracy_score'</span>].append(metrics[key][<span class="st">'accuracy_score'</span>])</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>      performances[<span class="st">'fail_ratio'</span>].append(metrics[key][<span class="st">'fail_ratio'</span>])</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> k <span class="kw">in</span> metrics[key][<span class="st">'cr'</span>][<span class="st">'macro avg'</span>].keys():</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">in</span> performances:</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>          performances[k].append(metrics[key][<span class="st">'cr'</span>][<span class="st">'weighted avg'</span>][k])</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame.from_dict(performances, orient<span class="op">=</span><span class="st">'index'</span>, columns<span class="op">=</span>metrics.keys())</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="bu">isinstance</span>(x, (<span class="bu">int</span>, <span class="bu">float</span>)) <span class="cf">else</span> x)</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.T</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tabulate(df, headers<span class="op">=</span>df.columns, tablefmt<span class="op">=</span><span class="st">"fancy_grid"</span>))</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_file:</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>      latex_table <span class="op">=</span> tabulate(df, headers<span class="op">=</span>df.columns, tablefmt<span class="op">=</span><span class="st">"latex"</span>)</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">.tex"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>        f.write(latex_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a9fe3b4c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:16.927858Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:16.927164Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:16.936000Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:16.935080Z&quot;}" data-outputid="f20affe8-e845-4675-eddc-95c35d7ad0ce" data-papermill="{&quot;duration&quot;:0.133294,&quot;end_time&quot;:&quot;2025-01-03T22:47:16.937799&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:16.804505&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>show_performances_table(metrics, save_file<span class="op">=</span> <span class="va">True</span>, file_name<span class="op">=</span> <span class="st">'overall_results'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╒═══════════════════╤══════════════════╤══════════════╤════════════╕
│                   │   accuracy_score │   fail_ratio │   f1-score │
╞═══════════════════╪══════════════════╪══════════════╪════════════╡
│ phi3_zero_shot    │            0.643 │            0 │      0.642 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ phi3_few_shot     │            0.67  │            0 │      0.668 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ mistral_zero_shot │            0.59  │            0 │      0.516 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ mistral_few_shot  │            0.697 │            0 │      0.679 │
╘═══════════════════╧══════════════════╧══════════════╧════════════╛</code></pre>
</div>
</div>
<p>By presenting the main metrics of the models in a table, we observe that all of them achieve the maximum possible score in fail_ratio, as none of the models produce incorrect answers.</p>
<p>Phi3 performs better in the zero-shot setting, but this may be due to the significant imbalance in Mistral’s predictions, as previously discussed. However, in the few-shot setting, Mistral shows a significant improvement, surpassing Phi3. This improvement could be attributed to Mistral’s larger size, with 7B parameters compared to 3.8B in Phi3. We hypothesize that the higher number of parameters helps Mistral better leverage the provided examples, resulting in improved few-shot performance.</p>
<section id="further-analysis" class="level3">
<h3 class="anchored" data-anchor-id="further-analysis">Further analysis</h3>
<p>To better understand the factors that lead the model to make errors, we conduct two explorations: - Since we limit the model’s token generation to 100 tokens and just one sentence, it is possible that some answers are followed by explanations. Including these explanations could provide a clearer understanding of the errors. We analyse whether such answers exist and identify which of them are misclassified. - We decide to plot all the words that appear more frequently in misclassified sentences. This is done to explore whether certain words are common across the models and whether they carry significant meaning for our task. Stop words are excluded to avoid misleading comparisons.</p>
</section>
<section id="wrong-answers-exploration" class="level3">
<h3 class="anchored" data-anchor-id="wrong-answers-exploration">Wrong answers Exploration</h3>
<p>We decide to explore all those misclassified sentences whose answer is followed by an explanation.</p>
<p>The output is structured in the following way:</p>
<ul>
<li>first line: the sentence misclassified</li>
<li>second line: the ground truth label</li>
<li>third line: the answer of the model</li>
</ul>
<div id="e986744a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:17.924397Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:17.923753Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:17.930582Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:17.929768Z&quot;}" data-papermill="{&quot;duration&quot;:0.131962,&quot;end_time&quot;:&quot;2025-01-03T22:47:17.932373&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:17.800411&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_sentence_explained(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                    predictions_df : pd.DataFrame,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                    model_name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">      Displays misclassified sentences with explanations.</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co">    predictions_df: a DataFrame containing the sentences, predictions and labels. (pd.DataFrame)</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name: name of the model for the plot title (str)</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_response(value):</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value.startswith(<span class="st">'YES'</span>):</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> value.startswith(<span class="st">'NO'</span>):</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    predictions_df[<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_mapped'</span>] <span class="op">=</span> predictions_df[model_name].<span class="bu">apply</span>(map_response)</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    predictions_df <span class="op">=</span> predictions_df[<span class="op">~</span>predictions_df[model_name].isin([<span class="st">'YES'</span>, <span class="st">'NO'</span>])]</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    predictions_df <span class="op">=</span> predictions_df[predictions_df[<span class="st">'label_sexist'</span>] <span class="op">!=</span> predictions_df[<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_mapped'</span>]].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(predictions_df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">'No answer with explanation given'</span>)</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> rows <span class="kw">in</span> predictions_df.iterrows():</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>        true_label <span class="op">=</span> <span class="st">'YES'</span> <span class="cf">if</span> rows[<span class="dv">1</span>][<span class="st">"label_sexist"</span>] <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'NO'</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>rows[<span class="dv">1</span>][<span class="st">"text"</span>]<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">ground truth: </span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">model pred: </span><span class="sc">{</span>rows[<span class="dv">1</span>][model_name]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'='</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="phi3" class="level3">
<h3 class="anchored" data-anchor-id="phi3">Phi3</h3>
<p>As we can see below, Phi3 model never gives an answer followed by an explanation, no analysis can be performed.</p>
<div id="ca545b81" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:18.464763Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:18.464007Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:18.475626Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:18.474680Z&quot;}" data-outputid="5da2fbfe-c202-4e88-ae66-f921f2189c90" data-papermill="{&quot;duration&quot;:0.137717,&quot;end_time&quot;:&quot;2025-01-03T22:47:18.477213&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:18.339496&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>display_sentence_explained(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'phi3_zero_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>No answer with explanation given</code></pre>
</div>
</div>
<div id="be0b0c50" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:18.727459Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:18.726655Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:18.734502Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:18.733688Z&quot;}" data-outputid="8579a4a9-00c6-4f87-a691-ffda09a18741" data-papermill="{&quot;duration&quot;:0.135914,&quot;end_time&quot;:&quot;2025-01-03T22:47:18.736008&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:18.600094&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>display_sentence_explained(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'phi3_few_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>No answer with explanation given</code></pre>
</div>
</div>
</section>
<section id="mistral" class="level3">
<h3 class="anchored" data-anchor-id="mistral">Mistral</h3>
<p>Looking at the answers given by Mistral, and the queried sentences, we notice that all the sentences are quite difficult to understand even for a human. Indeed, the explanation given is not completly wrong, but it seems like the model is not able to catch up the undertone meaning of the sentences.</p>
<div id="317b8c1e" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:19.474719Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:19.474112Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:19.481787Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:19.480979Z&quot;}" data-outputid="69b8e68e-5f93-462e-fa74-20e8cf0885f5" data-papermill="{&quot;duration&quot;:0.132971,&quot;end_time&quot;:&quot;2025-01-03T22:47:19.483298&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:19.350327&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>display_sentence_explained(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'mistral_zero_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tell that to Weev you lying shitskin son of a bitch. 
ground truth: YES 
model pred: NO (The text does not contain sexism. It is an insulting and offensive language, but it does not specifically target a person based on their gender.)
================================================================================</code></pre>
</div>
</div>
<div id="74d640d5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:19.733049Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:19.732163Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:19.741127Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:19.740113Z&quot;}" data-outputid="cbfb7479-c470-488a-f3d9-ec385b5ef667" data-papermill="{&quot;duration&quot;:0.136673,&quot;end_time&quot;:&quot;2025-01-03T22:47:19.742835&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:19.606162&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>display_sentence_explained(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'mistral_few_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Good - the grid girls can finally get back into F1 
ground truth: NO 
model pred: YES (This statement objectifies women and reduces them to their physical appearance, which is a form of sexism.)
================================================================================
The new Europeans are into all kinds of sex.... 
ground truth: NO 
model pred: YES (This statement seems to stereotype a group of people based on their nationality, which could be considered as a form of ethnic prejudice, not necessarily sexism, but it's important to note that ethnic prejudice can intersect with sexism.)
================================================================================
This is about false rape charges and how wives use the laws to torture and get money from the brides family.....highly recommend to watch full video ....its mind blowing 
ground truth: NO 
model pred: YES (The text seems to stereotype all wives, implying that they are prone to false rape charges and using the law to torture and extort money, which is a generalization and potentially harmful towards women.)
================================================================================
My state? I'm not Jewish. They literally won't stop until they destroy Israel and kill every Jewish person. Have you even read the Qur'an? It was created to give them a sanctuary if Nazi Germany type countries ever rose up again. 
ground truth: NO 
model pred: YES (The text contains a stereotype and generalization about a religious group, which can be considered as a form of prejudice, not necessarily sexism.)
================================================================================
[URL] Obviously written by an incel 
ground truth: NO 
model pred: YES (Assuming the URL leads to a text that contains sexist content)
================================================================================
Damn...this pisses me off to no end! These mother fuckers need to start gracing the halls of maximum security federal facilities! 
ground truth: NO 
model pred: YES (The text uses derogatory language and shows a generalized anger towards an unspecified group, which could be interpreted as a form of prejudice or discrimination, although not explicitly sexist.)
================================================================================
Karma's a bitch! 
ground truth: YES 
model pred: NO (The text does not contain sexism as it is a common idiomatic expression and does not target a specific gender.)
================================================================================
..oh Obama, dont even start with this kenyan hominid. I always pondered..His mother is a jew, he claims to be muslim....and fagg? yet jews claimed him as his own...oh about faggs...Obama put in risk lots of people with his "Laws" and "freedom". 
ground truth: NO 
model pred: YES (The text contains derogatory language towards multiple groups, including a racial slur and homophobic slur, which can be considered as hate speech.)
================================================================================
Full on crotch grab from Biden. Even the baby's mom isn't holding him that way. 
ground truth: NO 
model pred: YES (This statement implies a disrespectful and objectifying comment towards the woman, which can be considered sexist.)
================================================================================
I would love to suck her tits 
ground truth: NO 
model pred: YES (This statement objectifies a woman and is disrespectful, therefore it is sexist.)
================================================================================
I hate her. 
ground truth: NO 
model pred: YES (The text does not specify the gender of the person being hated, but the use of the generic "her" could be interpreted as sexist if it's used in a derogatory or disrespectful manner without a clear context)
================================================================================
Rrrrrr im going to fuck u in the ass for this 
ground truth: NO 
model pred: YES (This text contains sexist and violent language)
================================================================================
I try to act confident but girls dont even look at me 
ground truth: NO 
model pred: YES (This statement implies a generalization about all girls, which can be considered sexist.)
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="word-exploration" class="level2">
<h2 class="anchored" data-anchor-id="word-exploration">Word exploration</h2>
<p>Let’s explore whether any error patterns correlated with specific words emerge from the analysis.</p>
<div id="590daf82" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:20.535055Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:20.534323Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:20.544366Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:20.543551Z&quot;}" data-papermill="{&quot;duration&quot;:0.136501,&quot;end_time&quot;:&quot;2025-01-03T22:47:20.546037&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:20.409536&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_wrong_word(predictions_df: pd.DataFrame,</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>                    model_name: <span class="bu">str</span>,</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>                    top_wrongest: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows the most frequent words in wrong classified sentences.</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">    predictions_df: a DataFrame containing the sentences, predictions and labels. (pd.DataFrame)</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name: name of the model for the plot title (str)</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">    top_wrongest: number of words to show (int)</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_wrongest(df: pd.DataFrame, label: <span class="bu">int</span>, ax: matplotlib.axes.Axes) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"label_sexist"</span>] <span class="op">==</span> label]</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>        all_words <span class="op">=</span> Counter(</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>            word <span class="cf">for</span> row <span class="kw">in</span> df[<span class="st">"text"</span>] <span class="cf">for</span> word <span class="kw">in</span> row.split() <span class="cf">if</span> word <span class="kw">not</span> <span class="kw">in</span> stop_words</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>        df_wrong <span class="op">=</span> df[df[<span class="st">'label_sexist'</span>] <span class="op">!=</span> df[model_name]]</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>        wrongest_words <span class="op">=</span> Counter(</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>            word <span class="cf">for</span> row <span class="kw">in</span> df_wrong[<span class="st">"text"</span>] <span class="cf">for</span> word <span class="kw">in</span> row.split() <span class="cf">if</span> word <span class="kw">not</span> <span class="kw">in</span> stop_words</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>        wr_words, wr_counts <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>wrongest_words.most_common(top_wrongest)[:<span class="dv">0</span>:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>        ax.barh(wr_words, wr_counts, color<span class="op">=</span><span class="st">"skyblue"</span>, label<span class="op">=</span><span class="st">'Wrong Sentences'</span>)</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>        counts <span class="op">=</span> [all_words[word] <span class="cf">for</span> word <span class="kw">in</span> wr_words]</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>        ax.barh(wr_words, counts, color<span class="op">=</span><span class="st">"skyblue"</span>,alpha<span class="op">=</span><span class="fl">0.4</span>, label<span class="op">=</span><span class="st">'All Sentences'</span>)</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Wrongest words in label </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>        ax.xaxis.set_major_locator(MaxNLocator(integer<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_response(value):</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value.startswith(<span class="st">'YES'</span>):</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> value.startswith(<span class="st">'NO'</span>):</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>    predictions_df[<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> predictions_df[model_name].<span class="bu">apply</span>(map_response)</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>    stop_words <span class="op">=</span> <span class="bu">list</span>(stopwords.words(<span class="st">"english"</span>))</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">5</span>))</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> charts'</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>    find_wrongest(predictions_df, <span class="dv">0</span>, axs[<span class="dv">0</span>])</span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>    find_wrongest(predictions_df, <span class="dv">1</span>, axs[<span class="dv">1</span>])</span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="phi3-1" class="level3">
<h3 class="anchored" data-anchor-id="phi3-1">Phi3</h3>
<p>In the zero-shot setting, the model appears to show a possible bias towards associating terms like “<strong>women</strong>” and “<strong>woman</strong>” with errors in label 0 (non-sexist).</p>
<div id="7dbf4778" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:21.547222Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:21.546879Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:22.268570Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:22.267684Z&quot;}" data-outputid="07295a38-5bfa-4c2b-dc4e-b2bc7d966db4" data-papermill="{&quot;duration&quot;:0.847766,&quot;end_time&quot;:&quot;2025-01-03T22:47:22.270330&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:21.422564&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plot_wrong_word(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'phi3_zero_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In the few-shot setting certain patterns seem to persist, particularly for label 0 errors. This could indicate that the examples provided during few-shot prompting, although helpful, may not fully address the model’s tendency to misclassify based on specific terms.</p>
<div id="64a9d787" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:22.815468Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:22.814672Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:23.537081Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:23.535889Z&quot;}" data-outputid="c62ff371-bb10-402b-e266-0b0a71d377ef" data-papermill="{&quot;duration&quot;:0.851505,&quot;end_time&quot;:&quot;2025-01-03T22:47:23.539318&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:22.687813&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>plot_wrong_word(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'phi3_few_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-58-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mistral-1" class="level3">
<h3 class="anchored" data-anchor-id="mistral-1">Mistral</h3>
<p>From Mistral zero shot word exploration we can see: - In label 0 all the <strong>woman-related</strong> occurrences (women, girls, woman, female) have almost a 100% wrong ratio. But, remembering the confusion matrix above, this result is not so meaningful, since almost all the sentences are wrongly classified. We can hypotesise that almost all the words have a 100% wrong ratio. - In label 1, the number of misclassified sentences is very low (only 3), which makes it difficult to draw meaningful conclusions or identify clear patterns for this category.</p>
<div id="264462e0" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:24.304556Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:24.304234Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:24.875070Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:24.874165Z&quot;}" data-outputid="7abf1e05-ece6-4ff9-f041-4c7c96258c67" data-papermill="{&quot;duration&quot;:0.699522,&quot;end_time&quot;:&quot;2025-01-03T22:47:24.876707&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:24.177185&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>plot_wrong_word(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'mistral_zero_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-59-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From Mistral few shot word exploration we can see: - in label 0 the words that are most frequently misclassified include the woman-related ones (women, woman, girls, female). This could highlight some biases in the model that almost always associate a woman-related word to sexism. The presence of terms like “<strong>fat</strong>” and “<strong>white</strong>” also raises questions about the potential biases in the model, as these terms could be linked to specific stereotypes or contexts the model misinterprets. - in label 1 the diversity of terms could suggest a broader range of possible contexts or tasks where the model struggles, but thinking about the confusion matrix this could be probably related to the low number of errors (10).</p>
<div id="d4e71c72" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:25.423629Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:25.423310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:25.993837Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:25.992951Z&quot;}" data-outputid="8e0d5af3-bb47-459f-b025-935d87e7fd52" data-papermill="{&quot;duration&quot;:0.69994,&quot;end_time&quot;:&quot;2025-01-03T22:47:25.995442&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:25.295502&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>plot_wrong_word(responses_df.copy(), model_name<span class="op">=</span> <span class="st">'mistral_few_shot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-60-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="few-shot-experiments" class="level2">
<h2 class="anchored" data-anchor-id="few-shot-experiments">Few Shot Experiments</h2>
<p>We would like to analyse how much the predictions of the models, and consequently their performances, were correlated with the examples injected through the model prompt.</p>
<div id="f6e545d9" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:26.768455Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:26.767729Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-03T22:47:26.781631Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-03T22:47:26.780852Z&quot;}" data-papermill="{&quot;duration&quot;:0.145667,&quot;end_time&quot;:&quot;2025-01-03T22:47:26.783213&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:26.637546&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_variability(mode : <span class="bu">str</span>, demonstration_list : <span class="bu">list</span> <span class="op">=</span> [], num_per_class : <span class="bu">list</span> <span class="op">=</span> [], to_save : <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span> ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the metrics with different examples per classes.</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co">    mode: whether we are computing the quality or quantity variability</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="co">    demonstration_list: the list containting the demonstrations to be used</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="co">    num_per_class: a list containing the number of elements per class to use in the few shot prompting, to use whether demonstration_list is empty</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co">    to_save: boolean attribute, specify whther the table will be saved in your local environment</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> demonstration_list <span class="op">==</span> [] <span class="kw">and</span> num_per_class <span class="op">==</span> []:</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">assert</span> <span class="pp">ValueError</span>(<span class="st">'At least one between demonstration_list and num_per_class should be not default'</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    n_experiments <span class="op">=</span> <span class="bu">len</span>(demonstration_list) <span class="cf">if</span> demonstration_list <span class="op">!=</span> [] <span class="cf">else</span> <span class="bu">len</span>(num_per_class)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_metric_list(model, tokenizer, ax, model_name):</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>        metric_list <span class="op">=</span> {<span class="st">'fail_ratio'</span> : [], <span class="st">'accuracy'</span> : [], <span class="st">'examples'</span> : []}</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> n_example <span class="kw">in</span> tqdm(<span class="bu">range</span>(n_experiments), desc<span class="op">=</span><span class="st">"Generating responses"</span>):</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> capture_output():</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> demonstration_list <span class="op">!=</span> []:</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>                  data_loader <span class="op">=</span> prepare_prompts_few_shot(test_data, prompt_template<span class="op">=</span> few_shot_prompt,</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>                                                         tokenizer<span class="op">=</span> tokenizer, demonstration_samples<span class="op">=</span> demonstration_list[n_example])</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>                  metric_list[<span class="st">'examples'</span>].append(demonstration_list[n_example])</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>                  data_loader <span class="op">=</span> prepare_prompts_few_shot(test_data, prompt_template<span class="op">=</span> few_shot_prompt,</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>                                                         tokenizer<span class="op">=</span> tokenizer, num_per_class <span class="op">=</span> num_per_class[n_example])</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>                y_pred <span class="op">=</span> generate_responses(model, data_loader)</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> tokenizer.batch_decode(y_pred, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>            raw_response <span class="op">=</span> np.array([extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> response])</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>            metrics <span class="op">=</span> compute_metrics(raw_response, ground_truth)</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>            metric_list[<span class="st">'accuracy'</span>].append(metrics[<span class="st">"accuracy_score"</span>])</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>            metric_list[<span class="st">'fail_ratio'</span>].append(metrics[<span class="st">"fail_ratio"</span>])</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>            <span class="co">#json files checkpoints</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> to_save:</span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> model <span class="op">==</span> model_1:</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> mode <span class="op">==</span> <span class="st">'quality'</span>:</span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"metric_list_quality_phi_</span><span class="sc">{</span>n_example<span class="sc">}</span><span class="ss">.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> json_file:</span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>                          json.dump(metric_list, json_file, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">else</span>:</span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"metric_list_quantity_phi_</span><span class="sc">{</span>n_example<span class="sc">}</span><span class="ss">.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> json_file:</span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>                          json.dump(metric_list, json_file, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>              <span class="cf">else</span>:</span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> mode <span class="op">==</span> <span class="st">'quality'</span>:</span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"metric_list_quality_mistral_</span><span class="sc">{</span>n_example<span class="sc">}</span><span class="ss">.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> json_file:</span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>                          json.dump(metric_list, json_file, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">else</span>:</span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"metric_list_quantity_mistral_</span><span class="sc">{</span>n_example<span class="sc">}</span><span class="ss">.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> json_file:</span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>                          json.dump(metric_list, json_file, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>        bars <span class="op">=</span> ax.bar(<span class="bu">range</span>(<span class="dv">1</span>, n_experiments<span class="op">+</span><span class="dv">1</span>), metric_list[<span class="st">'accuracy'</span>])</span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="bu">len</span>(metric_list[<span class="st">'accuracy'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>            yval <span class="op">=</span> bar.get_height()</span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>            ax.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="ss">f'</span><span class="sc">{</span>yval<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mode <span class="op">==</span> <span class="st">'quality'</span>:</span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>            ax.set_xticks([])</span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>            ax.set_xlabel(<span class="st">'Experiments'</span>)</span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>            ax.set_xticks(np.arange(<span class="dv">1</span>, n_experiments<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>            ax.set_xlabel(<span class="st">'Number of examples'</span>)</span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>        ax.set_yticks(np.arange(<span class="dv">0</span>, <span class="fl">1.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Accuracy score'</span>)</span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span> (<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mode <span class="op">==</span> <span class="st">'quality'</span>:</span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="ss">f'Accuracy variability choosing 2 different examples per class'</span>)</span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="ss">f'Accuracy variability increasing the number of examples per class'</span>)</span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>    compute_metric_list(model_1, tokenizer_1, axs[<span class="dv">0</span>], <span class="st">'Phi3'</span>)</span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>    compute_metric_list(model_2, tokenizer_2, axs[<span class="dv">1</span>], <span class="st">'Mistral'</span>)</span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="qualitative-analysis" class="level3">
<h3 class="anchored" data-anchor-id="qualitative-analysis">Qualitative Analysis</h3>
<p>The first analysis investigates how the model’s performance is influenced by the examples provided in the few-shot setup. In this experiment, the model generates predictions ten times, using a different set of examples in the prompt for each run. In each case, two examples per class are randomly selected and remain consistent throughout that specific run. This approach allows us to observe how the choice of examples impacts the model’s output.</p>
<p>From the plot below, we can observe that for both models, their performance fluctuates significantly depending on the examples given as input. This suggests that the choice of few-shot examples can heavily influence the model’s predictions, highlighting the sensitivity of the few-shot approach to input selection.</p>
<p>Such variability underscores the importance of carefully curating examples for few-shot learning tasks to ensure robust and consistent performance.</p>
<div id="03b0fc10" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-03T22:47:27.546453Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-03T22:47:27.545529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T00:33:45.706659Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T00:33:45.705663Z&quot;}" data-outputid="5a20b3a3-9e22-4c9f-8293-ad7dd940ad60" data-papermill="{&quot;duration&quot;:6378.292201,&quot;end_time&quot;:&quot;2025-01-04T00:33:45.708652&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-03T22:47:27.416451&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>n_experiments <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>demonstration_quality_var <span class="op">=</span> [build_few_shot_demonstrations(demonstrations, num_per_class<span class="op">=</span> <span class="dv">2</span>) <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(n_experiments)]</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>plot_variability(mode<span class="op">=</span> <span class="st">'quality'</span>, demonstration_list<span class="op">=</span> demonstration_quality_var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 10/10 [34:03&lt;00:00, 204.31s/it]
Generating responses: 100%|██████████| 10/10 [1:12:14&lt;00:00, 433.48s/it]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-62-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To address this issue, we decide to modify the examples provided in each prompt by randomly selecting them during each run. This approach ensures that within a single run, each of the 300 prompts contains a different set of examples, resulting in a total of 1,200 unique examples sampled from the demonstration dataset. By introducing this variability, we aim to reduce the model’s sensitivity to specific fixed examples. We conduct 10 separate experiments to maintain consistency with the previous analysis. This experimental setup allows us to make more robust comparisons and avoid drawing false conclusions based on isolated runs.</p>
<p>From the plots below, it is evident that, although some degree of variability in performance persists, the fluctuations are significantly reduced compared to when using a fixed set of examples across all prompts. This indicates that varying the examples contributes to a more stable model performance and reduces its sensitivity to specific demonstrations.</p>
<p>Furthermore, it is important to note that none of the trials achieve peak performance. This observation suggests that the choice of examples is central in few-shot prompting, as the examples directly influence the model’s ability to generalize and adapt to the task. To achieve the best possible results, examples should be carefully selected.</p>
<p>Based on these findings, we decide to consistently adopt the strategy of varying the examples in subsequent experiments.</p>
<div id="f5929d8e" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T00:33:46.247390Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T00:33:46.246780Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T02:21:24.093310Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T02:21:24.092387Z&quot;}" data-outputid="f84c1cf5-b235-4656-e67f-210fc459b47b" data-papermill="{&quot;duration&quot;:6457.981553,&quot;end_time&quot;:&quot;2025-01-04T02:21:24.095099&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T00:33:46.113546&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>n_experiments<span class="op">=</span> <span class="dv">10</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>plot_variability(mode<span class="op">=</span> <span class="st">'quality'</span>, num_per_class<span class="op">=</span> [<span class="dv">2</span>]<span class="op">*</span>n_experiments, to_save <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 10/10 [34:57&lt;00:00, 209.75s/it]
Generating responses: 100%|██████████| 10/10 [1:12:39&lt;00:00, 436.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-63-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="quantitative-analysis" class="level3">
<h3 class="anchored" data-anchor-id="quantitative-analysis">Quantitative Analysis</h3>
<p>We also conducted experiments to investigate the impact of varying the number of examples per class on model performance. By testing a range spanning from 1 to 5 examples per class, we observed that there was no clear correlation between the number of examples and the overall accuracy. Interestingly, the results suggest that using two or three examples per class tends to yield the most stable and optimal performance.</p>
<p>This finding indicates that beyond a certain point, increasing the number of examples may not significantly enhance accuracy and could even introduce diminishing returns in performance. Therefore, selecting two or three examples per class appears to strike the right balance between providing sufficient context and avoiding unnecessary complexity in the prompt.</p>
<div id="237ca885" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T02:21:24.917379Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T02:21:24.916571Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:21:27.054689Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:21:27.053683Z&quot;}" data-outputid="18eb0469-04fe-449e-ddbb-24d8721d9ab2" data-papermill="{&quot;duration&quot;:3602.269541,&quot;end_time&quot;:&quot;2025-01-04T03:21:27.056375&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T02:21:24.786834&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>n_experiments <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>num_per_class_list<span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, n_experiments<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>plot_variability(mode<span class="op">=</span> <span class="st">'quantity'</span>, num_per_class<span class="op">=</span> num_per_class_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 5/5 [20:04&lt;00:00, 240.92s/it]
Generating responses: 100%|██████████| 5/5 [39:57&lt;00:00, 479.44s/it]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_2_baiocchi_dibuo_petrilli_files/figure-html/cell-64-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="experiments" class="level1">
<h1>Experiments</h1>
<section id="cot" class="level2">
<h2 class="anchored" data-anchor-id="cot">CoT</h2>
<p>We decide to explore the Chain of Thought technique. Our objective is to guide the model reasoning trying to increase its performances. We try this technique for both Phi3 and Mistral v3.</p>
<p>We add some instruction in the prompt template, giving some general reasoning tools to classify the sentences. Due to the high variability related to the examples found out in the previous section, we decide to not give the model specific examples with explanation, but just some general rules.</p>
<div id="f219bc06" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:21:28.114321Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:21:28.113995Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:21:28.118615Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:21:28.117777Z&quot;}" data-papermill="{&quot;duration&quot;:0.136684,&quot;end_time&quot;:&quot;2025-01-04T03:21:28.120200&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:21:27.983516&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>prompt_cot <span class="op">=</span> [</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'system'</span>,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">'You are an annotator for sexism detection.'</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'role'</span>: <span class="st">'user'</span>,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'content'</span>: <span class="st">"""Your task is to classify input text as containing sexism or not. Respond only YES or NO.</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="st">        Think step by step. A sentence is more likely to contain sexism when:</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="st">        A woman is associated to an object; a person is discriminated on the basis of its sex; a person, especially a woman, is denigrated due to sexual</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="st">        comments.</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="st">        TEXT:</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">{text}</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="st">        ANSWER:</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the following sections we introduce the <code>full_pipeline</code> function which avoids multiple repetitions of the same code.</p>
<div id="bb2c3074" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:21:28.654602Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:21:28.653911Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:21:28.660021Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:21:28.659205Z&quot;}" data-papermill="{&quot;duration&quot;:0.142152,&quot;end_time&quot;:&quot;2025-01-04T03:21:28.661575&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:21:28.519423&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> full_pipeline(prompt : <span class="bu">str</span>, prompting_technique_name : <span class="bu">str</span>, performances : <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Implements the full pipeline from the preparation of the prompts to the metrics saving.</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt: the type of prompt</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co">    prompting_technique_name: the name of the prompting technique</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co">    performances: dictionary in which store the computed metrics</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model, tokenizer <span class="kw">in</span> <span class="bu">zip</span>((model_1, model_2), (tokenizer_1, tokenizer_2)):</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        model_name <span class="op">=</span> <span class="st">'Phi3'</span> <span class="cf">if</span> model <span class="op">==</span> model_1 <span class="cf">else</span> <span class="st">'Mistral'</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prompting_technique_name <span class="op">==</span> <span class="st">'few_shot'</span>:</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>            data_loader <span class="op">=</span> prepare_prompts_few_shot(test_data, prompt, tokenizer, num_per_class <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>            data_loader <span class="op">=</span> prepare_prompts(test_data, prompt, tokenizer)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> generate_responses(model, data_loader)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> tokenizer.batch_decode(model_response, skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>        model_response <span class="op">=</span> [extract_response(item) <span class="cf">for</span> item <span class="kw">in</span> model_response]</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>        performances[<span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>prompting_technique_name<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> compute_metrics(model_response, ground_truth)</span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> performances</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d66c8fca" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:21:28.960828Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:21:28.960126Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:34.819201Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:34.818166Z&quot;}" data-outputid="b6e38b41-83ed-45ac-c4dc-fdd982567c70" data-papermill="{&quot;duration&quot;:425.992581,&quot;end_time&quot;:&quot;2025-01-04T03:28:34.820924&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:21:28.828343&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>performances <span class="op">=</span> full_pipeline(prompt_cot, <span class="st">'CoT'</span>, {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3f15afe03e4a4c7ba03a2513a783a574","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.
        Think step by step. A sentence is more likely to contain sexism when:
        A woman is associated to an object; a person is discriminated on the basis of its sex; a person, especially a woman, is denigrated due to sexual
        comments.
        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 300/300 [02:32&lt;00:00,  1.97it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"65ddd0a495c6436d9791298bdce304a1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.
        Think step by step. A sentence is more likely to contain sexism when:
        A woman is associated to an object; a person is discriminated on the basis of its sex; a person, especially a woman, is denigrated due to sexual
        comments.
        TEXT:
        The boys must be gaming because there goes the wifi.

        ANSWER:
        [/INST]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 300/300 [04:33&lt;00:00,  1.10it/s]</code></pre>
</div>
</div>
<div id="219f15cb" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:35.156492Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:35.155775Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:35.162996Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:35.162129Z&quot;}" data-outputid="c0be08f4-237e-4fe8-b477-d3ea8d7816a1" data-papermill="{&quot;duration&quot;:0.182007,&quot;end_time&quot;:&quot;2025-01-04T03:28:35.164677&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:34.982670&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>show_performances_table(performances, save_file<span class="op">=</span> <span class="va">True</span>, file_name<span class="op">=</span> <span class="st">'CoT_results'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╒═════════════╤══════════════════╤══════════════╤════════════╕
│             │   accuracy_score │   fail_ratio │   f1-score │
╞═════════════╪══════════════════╪══════════════╪════════════╡
│ Phi3_CoT    │            0.73  │            0 │      0.723 │
├─────────────┼──────────────────┼──────────────┼────────────┤
│ Mistral_CoT │            0.647 │            0 │      0.608 │
╘═════════════╧══════════════════╧══════════════╧════════════╛</code></pre>
</div>
</div>
<p>Phi3 exhibits a more substantial performance boost with this technique, achieving results that even surpass its few-shot performance. In contrast, Mistral does not exhibit similar improvements, as its performance remains lower than that of its few-shot implementation. Specifically, when randomly selecting different examples per class in the few-shot setup, Mistral achieves an average accuracy of 0.7, which it fails to exceed with the current approach.</p>
</section>
<section id="a1-dataset" class="level2">
<h2 class="anchored" data-anchor-id="a1-dataset">A1 dataset</h2>
<p>In this subsection, our goal is to evaluate the two models using the dataset provided in Assignment 1. To achieve this, we use the test set to query the models while utilizing the training set as the demonstration set for few-shot prompting. The models are evaluated using the three prompting techniques discussed earlier.</p>
<div id="ac02a877" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:36.476480Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:36.475782Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:38.692980Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:38.692283Z&quot;}" data-papermill="{&quot;duration&quot;:2.380354,&quot;end_time&quot;:&quot;2025-01-04T03:28:38.694957&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:36.314603&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/nlp-unibo/nlp-course-material/main/2024-2025/Assignment%201/data/'</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.read_json(url <span class="op">+</span> <span class="st">'test.json'</span>).T</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.read_json(url <span class="op">+</span> <span class="st">'training.json'</span>).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We preprocess the dataset as follows: - we keep only the english tweets - we remove the emoticons, urls, users mentions and special charcaters</p>
<div id="b5cc3e74" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:39.375703Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:39.374961Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:39.456133Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:39.455444Z&quot;}" data-papermill="{&quot;duration&quot;:0.29213,&quot;end_time&quot;:&quot;2025-01-04T03:28:39.458127&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:39.165997&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> determine_label(row: pd.Series) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Converts soft labels into hard labels (strings).</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co">    :param row: row of the dataset to convert (pd.Series)</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="co">    :return</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co">        - string representing the hard label</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    num_yes <span class="op">=</span> row[<span class="st">"labels_task1"</span>].count(<span class="st">"YES"</span>)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>    num_no <span class="op">=</span> row[<span class="st">"labels_task1"</span>].count(<span class="st">"NO"</span>)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> num_yes <span class="op">==</span> num_no:</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"YES"</span> <span class="cf">if</span> num_yes <span class="op">&gt;</span> num_no <span class="cf">else</span> <span class="st">"NO"</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corpus(df: pd.DataFrame, multilingual:<span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Converts soft labels into hard labels (int) and drops irrelevant rows/columns.</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a><span class="co">    df: dataset split to convert (pd.DataFrame)</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a><span class="co">    multilingual: whether to keep spanish tweets (bool)</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Output:</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a><span class="co">        - refined dataset</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hard_label_task1"</span>] <span class="op">=</span> df.<span class="bu">apply</span>(determine_label, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"hard_label_task1"</span>])</span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> multilingual:</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> df[df[<span class="st">"lang"</span>] <span class="op">!=</span> <span class="st">"es"</span>]</span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[[<span class="st">"id_EXIST"</span>, <span class="st">"lang"</span>, <span class="st">"tweet"</span>, <span class="st">"hard_label_task1"</span>]]</span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">"hard_label_task1"</span>] <span class="op">==</span> <span class="st">"YES"</span>, <span class="st">"hard_label_task1"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">"hard_label_task1"</span>] <span class="op">==</span> <span class="st">"NO"</span>, <span class="st">"hard_label_task1"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>    df.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> corpus(test_df)</span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> corpus(train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cc2d7a29" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:39.779706Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:39.779349Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:40.074101Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:40.073090Z&quot;}" data-papermill="{&quot;duration&quot;:0.458095,&quot;end_time&quot;:&quot;2025-01-04T03:28:40.076103&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:39.618008&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/muan/unicode-emoji-json/main/data-by-emoji.json'</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>json_data <span class="op">=</span> response.json()</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>emoji_list <span class="op">=</span> <span class="bu">list</span>(json_data.keys())</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>regex_pattern <span class="op">=</span> <span class="st">"|"</span>.join(re.escape(word) <span class="cf">for</span> word <span class="kw">in</span> emoji_list)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>regex <span class="op">=</span> re.<span class="bu">compile</span>(regex_pattern)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7cdf8e8d" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:40.399676Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:40.399273Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:41.697970Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:41.697260Z&quot;}" data-papermill="{&quot;duration&quot;:1.463138,&quot;end_time&quot;:&quot;2025-01-04T03:28:41.699885&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:40.236747&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_cleaning(tweet: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    tweet <span class="op">=</span> re.sub(regex.pattern,<span class="st">' '</span>,tweet)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    tweet <span class="op">=</span> re.sub(<span class="vs">r'\B\@(\w)+'</span>,<span class="st">' '</span>,tweet)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#tweet = re.sub(r'\B\#(\w)+',' ',tweet)</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    tweet <span class="op">=</span> re.sub(<span class="vs">r'https?://\S*'</span>, <span class="st">' '</span>, tweet)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    tweet <span class="op">=</span> re.sub(<span class="vs">r"[^a-zA-Z]"</span>, <span class="st">' '</span>, tweet)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    tweet <span class="op">=</span> tweet.lower()</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tweet</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'tweet'</span>] <span class="op">=</span> test_df[<span class="st">'tweet'</span>].<span class="bu">apply</span>(data_cleaning)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'tweet'</span>] <span class="op">=</span> train_df[<span class="st">'tweet'</span>].<span class="bu">apply</span>(data_cleaning)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3b1d40a1" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:42.022008Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:42.021660Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:42.034042Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:42.033222Z&quot;}" data-outputid="f57e9a43-ad76-4a4f-834a-c7b673f0af51" data-papermill="{&quot;duration&quot;:0.174976,&quot;end_time&quot;:&quot;2025-01-04T03:28:42.035875&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:41.860899&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> test_df.rename(columns<span class="op">=</span>{<span class="st">'tweet'</span> : <span class="st">'text'</span>, <span class="st">'hard_label_task1'</span> : <span class="st">'label_sexist'</span>})</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> train_df.rename(columns<span class="op">=</span>{<span class="st">'tweet'</span> : <span class="st">'text'</span>, <span class="st">'hard_label_task1'</span> : <span class="st">'label_sexist'</span>})</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>test_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id_EXIST</th>
<th data-quarto-table-cell-role="th">lang</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label_sexist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>400178</td>
<td>en</td>
<td>st day at the pool on a beautiful sunday in n...</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>400179</td>
<td>en</td>
<td>i like your outfit too except when i dress up...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>400180</td>
<td>en</td>
<td>same though the angst just comes and ...</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>400181</td>
<td>en</td>
<td>fuck that cunt tried to vote her out mult...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>400182</td>
<td>en</td>
<td>u gotta say some shit like i ll fuck that c...</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e81beab8" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:42.353383Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:42.353051Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:42.358319Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:42.357628Z&quot;}" data-papermill="{&quot;duration&quot;:0.163382,&quot;end_time&quot;:&quot;2025-01-04T03:28:42.359914&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:42.196532&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'label_sexist'</span>] <span class="op">=</span> train_df[<span class="st">'label_sexist'</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x : <span class="st">'YES'</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'NO'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3a4bfce5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:42.721204Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:42.720501Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:28:42.732487Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:28:42.731681Z&quot;}" data-papermill="{&quot;duration&quot;:0.176291,&quot;end_time&quot;:&quot;2025-01-04T03:28:42.734058&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:42.557767&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> Dataset.from_pandas(test_df)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>ground_truth <span class="op">=</span> np.array(test_data[<span class="st">'label_sexist'</span>])</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> {<span class="st">'zero_shot'</span> : [], <span class="st">'few_shot'</span> : [], <span class="st">'CoT'</span> : []}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="zero-shot-prompting" class="level3">
<h3 class="anchored" data-anchor-id="zero-shot-prompting">Zero shot prompting</h3>
<div id="499756bb" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:28:43.372767Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:28:43.372392Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:34:31.402584Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:34:31.401601Z&quot;}" data-outputid="2a2de9bb-a9a9-4b4e-a0cb-f5b5903b3eb8" data-papermill="{&quot;duration&quot;:348.197532,&quot;end_time&quot;:&quot;2025-01-04T03:34:31.404353&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:28:43.206821&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>performances <span class="op">=</span> full_pipeline(zero_shot_prompt, <span class="st">'zero_shot'</span>, {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"72a8037a033d420d8ec7e7d2f7821cb9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [02:11&lt;00:00,  2.18it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d4c2a68dc69a4dc99c2ec0c74d6069b5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        [/INST]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [03:36&lt;00:00,  1.32it/s]</code></pre>
</div>
</div>
</section>
<section id="few-shot-prompting" class="level3">
<h3 class="anchored" data-anchor-id="few-shot-prompting">Few Shot prompting</h3>
<div id="2ba4a32c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:34:32.184611Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:34:32.184275Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:44:29.599160Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:44:29.598291Z&quot;}" data-outputid="841e0459-bd3e-43e4-c7c6-6f54c2079da9" data-papermill="{&quot;duration&quot;:597.598026,&quot;end_time&quot;:&quot;2025-01-04T03:44:29.600986&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:34:32.002960&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>performances <span class="op">=</span> full_pipeline(few_shot_prompt, <span class="st">'few_shot'</span>, performances)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3131205d9c7442298e18adeb7388136d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        EXAMPLES:
        TEXT: So you are mainly attracted to Asian women who have white fever and 10 ex white boyfriends?
ANSWER: YES
TEXT: Now dat rubber rounds are badass they will mame dat shithead for life possibly make him / her disabled
ANSWER: NO
TEXT: No way that dumb bitch could put a sentence like that together... Someone else wrote it, she memorized it...
ANSWER: YES
TEXT: Yep, in modern America when you molest little boys, you get a more lenient sentence (none) than stating verifiable facts about the holocaust in most of Europe. This is so something to celebrate. 👏. 👏. 👏.
ANSWER: NO

        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [03:18&lt;00:00,  1.44it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fb38bf70a76847da94c0698a06c00bfa","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.

        EXAMPLES:
        TEXT: The SMF Social media female. Everything this type of female does is for her social media.
ANSWER: YES
TEXT: ROFLMAO.... She's a little thing so ducking to her level is ill advised
ANSWER: NO
TEXT: Yeah with Mgtow Day approaching (Feb 14) I already women being childish, it'll create a surge for sure.
ANSWER: YES
TEXT: Don't mess with granny!
ANSWER: NO

        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        [/INST]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [06:37&lt;00:00,  1.39s/it]</code></pre>
</div>
</div>
</section>
<section id="chain-of-thought-prompting" class="level3">
<h3 class="anchored" data-anchor-id="chain-of-thought-prompting">Chain of Thought prompting</h3>
<div id="b5d10143" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:44:30.515850Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:44:30.515497Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:51:05.770076Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:51:05.769042Z&quot;}" data-outputid="ec376664-2dc5-43f0-f29a-fe2442ac3914" data-papermill="{&quot;duration&quot;:395.478431,&quot;end_time&quot;:&quot;2025-01-04T03:51:05.771656&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:44:30.293225&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>performances <span class="op">=</span> full_pipeline(prompt_cot, <span class="st">'CoT'</span>, performances)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cbbe024fe7714e4795240cf3cadbda32","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;|system|&gt;
You are an annotator for sexism detection.&lt;|end|&gt;
&lt;|user|&gt;
Your task is to classify input text as containing sexism or not. Respond only YES or NO.
        Think step by step. A sentence is more likely to contain sexism when:
        A woman is associated to an object; a person is discriminated on the basis of its sex; a person, especially a woman, is denigrated due to sexual
        comments.
        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        &lt;|end|&gt;
&lt;|assistant|&gt;
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [02:25&lt;00:00,  1.96it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6b12a7a6386b4326b49b64286da67246","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;s&gt;[INST] You are an annotator for sexism detection.

Your task is to classify input text as containing sexism or not. Respond only YES or NO.
        Think step by step. A sentence is more likely to contain sexism when:
        A woman is associated to an object; a person is discriminated on the basis of its sex; a person, especially a woman, is denigrated due to sexual
        comments.
        TEXT:
         st day at the pool on a beautiful sunday in ny  too bad few dared to go in due to the frigid water temp  we lasted    min and figured we proved our point     

        ANSWER:
        [/INST]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Generating responses: 100%|██████████| 286/286 [04:08&lt;00:00,  1.15it/s]</code></pre>
</div>
</div>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<div id="d4d39bfc" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-01-04T03:51:06.789349Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-01-04T03:51:06.788357Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-01-04T03:51:06.796487Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-01-04T03:51:06.795684Z&quot;}" data-outputid="240e0ffc-cba5-4fe0-ed5f-788342ba4e6e" data-papermill="{&quot;duration&quot;:0.290987,&quot;end_time&quot;:&quot;2025-01-04T03:51:06.798117&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-01-04T03:51:06.507130&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>show_performances_table(performances, save_file<span class="op">=</span> <span class="va">True</span>, file_name<span class="op">=</span> <span class="st">'Results_A1_assignment'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>╒═══════════════════╤══════════════════╤══════════════╤════════════╕
│                   │   accuracy_score │   fail_ratio │   f1-score │
╞═══════════════════╪══════════════════╪══════════════╪════════════╡
│ Phi3_zero_shot    │            0.72  │            0 │      0.721 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ Mistral_zero_shot │            0.759 │            0 │      0.757 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ Phi3_few_shot     │            0.699 │            0 │      0.684 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ Mistral_few_shot  │            0.801 │            0 │      0.799 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ Phi3_CoT          │            0.766 │            0 │      0.765 │
├───────────────────┼──────────────────┼──────────────┼────────────┤
│ Mistral_CoT       │            0.79  │            0 │      0.791 │
╘═══════════════════╧══════════════════╧══════════════╧════════════╛</code></pre>
</div>
</div>
<p>The <strong>Mistral_few_shot</strong> model achieves the highest accuracy at 0.801, outperforming all other models. The Phi3_few_shot model has the lowest accuracy at 0.699, suggesting that it may be less effective for the task when compared to Mistral-based models. Models that involve zero-shot or CoT techniques (e.g., Phi3_zero_shot and Mistral_CoT) show accuracy in the mid-range, with Mistral-based models generally outperforming Phi3-based ones.</p>
<p>All models report a fail ratio of 0, meaning no model experienced failure during the task. This is an important indicator that the models are stable and did not encounter issues like errors or incomplete predictions during evaluation.</p>
<p>The Mistral-based models (both zero_shot, few_shot, and CoT) tend to outperform the Phi3-based models across all three metrics (accuracy, fail ratio, f1-score). Few-shot learning appears to provide the best performance across the board, suggesting that the few-shot approach is particularly effective for these tasks.</p>
</section>
</section>
</section>
<section id="task-7---1.0-points-report" class="level1">
<h1>[Task 7 - 1.0 points] Report</h1>
<p>Wrap up your experiment in a short report (up to 2 pages).</p>
<section id="instructions-7" class="level3">
<h3 class="anchored" data-anchor-id="instructions-7">Instructions</h3>
<ul>
<li><p>Use the NLP course report template.</p></li>
<li><p>Summarize each task in the report following the provided template.</p></li>
</ul>
</section>
<section id="recommendations" class="level3">
<h3 class="anchored" data-anchor-id="recommendations">Recommendations</h3>
<p>The report is not a copy-paste of graphs, tables, and command outputs.</p>
<ul>
<li><p>Summarize classification performance in Table format.</p></li>
<li><p><strong>Do not</strong> report command outputs or screenshots.</p></li>
<li><p>Report learning curves in Figure format.</p></li>
<li><p>The error analysis section should summarize your findings.</p></li>
</ul>
</section>
</section>
<section id="submission" class="level1">
<h1>Submission</h1>
<ul>
<li><p><strong>Submit</strong> your report in PDF format.</p></li>
<li><p><strong>Submit</strong> your python notebook.</p></li>
<li><p>Make sure your notebook is <strong>well organized</strong>, with no temporary code, commented sections, tests, etc…</p></li>
</ul>
</section>
<section id="faq" class="level1">
<h1>FAQ</h1>
<p>Please check this frequently asked questions before contacting us.</p>
<section id="model-cards" class="level3">
<h3 class="anchored" data-anchor-id="model-cards">Model cards</h3>
<p>You can pick any open-source model card you like.</p>
<p>We recommend starting from those reported in this assignment.</p>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>Everything can be done via <code>transformers</code> APIs.</p>
<p>However, you are free to test frameworks, such as <a href="https://www.langchain.com/">LangChain</a>, <a href="https://www.llamaindex.ai/">LlamaIndex</a> <a href="https://github.com/awesome-software/lit-parrot">LitParrot</a>, provided that you correctly address task instructions.</p>
</section>
<section id="bonus-points" class="level3">
<h3 class="anchored" data-anchor-id="bonus-points">Bonus Points</h3>
<p>0.5 bonus points are arbitrarily assigned based on significant contributions such as:</p>
<ul>
<li><p>Outstanding error analysis</p></li>
<li><p>Masterclass code organization</p></li>
<li><p>Suitable extensions</p></li>
<li><p>Evaluate A1 dataset and perform comparison</p></li>
</ul>
<p>Note that bonus points are only assigned if all task points are attributed (i.e., 6/6).</p>
</section>
<section id="prompt-template-1" class="level3">
<h3 class="anchored" data-anchor-id="prompt-template-1">Prompt Template</h3>
<p>Do not change the provided prompt template.</p>
<p>You are only allowed to change it in case of a possible extension.</p>
</section>
<section id="optimizations" class="level3">
<h3 class="anchored" data-anchor-id="optimizations">Optimizations</h3>
<p>Any kind of code optimization (e.g., speedup model inference or reduce computational cost) is more than welcome!</p>
</section>
</section>
<section id="the-end" class="level1">
<h1>The End</h1>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>